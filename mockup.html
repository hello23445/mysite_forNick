<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mockup Studio Pro | 3D Perspective</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0b0f19; color: white; margin: 0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è 3D */
        .perspective-container {
            perspective: 1200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #device-frame {
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), border-color 0.3s ease;
            transform-style: preserve-3d;
            border-style: solid;
        }

        .active-btn { 
            border-color: #3b82f6 !important; 
            background: rgba(59, 130, 246, 0.2) !important; 
            color: #fff !important;
        }

        /* –≠–∫—Ä–∞–Ω—ã */
        #screen-bg {
            width: 100%; height: 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            transition: background-image 0.3s;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        @keyframes toast {
            0% { transform: translateY(100px); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
        #toast { display: none; animation: toast 3s forwards; }

        /* –ü—Ä–µ–ª–æ–∞–¥–µ—Ä –≤–∏–¥–µ–æ */
        .spinner { width:28px; height:28px; border:3px solid rgba(255,255,255,0.08); border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:60}
        .modal{background:#0f1724;padding:18px;border-radius:12px;max-width:420px;color:#e6edf3;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(2,6,23,0.6)}
        .modal .modal-title{font-weight:600;margin-bottom:8px;color:#60a5fa}
        .modal .modal-body{font-size:13px;color:#cbd5e1;margin-bottom:12px}
        .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end}
        .modal .btn{padding:8px 12px;border-radius:8px;background:#111827;color:#fff;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
        .modal .btn.primary{background:#3b82f6}

        /* Drag and Drop */
        .drag-over {
            border-color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.3) !important;
        }

        /* –°–∫—Ä–æ–ª –¥–ª—è —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        .device-scroll { max-height: 200px; overflow-y: auto; }

        /* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –Ω–æ—É—Ç–±—É–∫–æ–≤ */
        #keyboard { 
            display: none; 
            width: 100%; 
            height: 60px; 
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%); 
            border-radius: 0 0 inherit inherit; 
            position: absolute; 
            bottom: 0; 
            left: 0;
            padding: 8px;
            box-sizing: border-box;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            align-content: flex-start;
            overflow: hidden;
        }
        
        #keyboard::before {
            content: '';
            position: absolute;
            width: 90%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            top: 0;
            left: 5%;
        }
        
        .key {
            width: 8%; height: 18px; background: #333; border: 1px solid #222; border-radius: 2px; flex-shrink: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] bg-green-500 text-white px-8 py-4 rounded-2xl shadow-2xl font-bold flex items-center gap-3">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        –ú–æ–∫–∞–ø –≥–æ—Ç–æ–≤!
    </div>

    <header class="py-4 border-b border-gray-800 bg-slate-900/50 backdrop-blur-md sticky top-0 z-50 px-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tighter">MOCKUP<span class="text-blue-500">GEN</span></h1>
            <span class="text-[10px] text-gray-500 font-mono border border-gray-800 px-2 py-1 rounded">PRO EDITION v3</span>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 p-6">
        
        <div class="lg:col-span-4 space-y-3 pr-2">
            
            <div class="glass p-5 rounded-2xl flex-shrink-0">
                <h3 class="text-[10px] font-bold text-blue-400 mb-3 uppercase tracking-widest">1. –ö–æ–Ω—Ç–µ–Ω—Ç —ç–∫—Ä–∞–Ω–∞</h3>
                <input type="file" id="contentUpload" class="hidden" />
                <div id="dropZone" class="w-full py-3 border-2 border-dashed border-slate-700 rounded-xl text-xs text-slate-400 hover:border-blue-500 hover:text-blue-400 transition-all cursor-pointer text-center"
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" onclick="document.getElementById('contentUpload').click()">
                    üìé <span id="dropZoneText">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ</span>
                </div>
                <p id="premiumMessage" class="text-[8px] font-bold text-blue-400 mt-2 uppercase tracking-widest text-center" style="display:none;">
                    –ö—É–ø–∏—Ç–µ Premium, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–∏–¥–µ–æ
                </p>
            </div>

            <div class="glass p-5 rounded-2xl flex-shrink-0">
                <h3 class="text-[10px] font-bold text-blue-400 mb-3 uppercase tracking-widest">2. –ú–æ–¥–µ–ª—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
                <div class="device-scroll grid grid-cols-1 gap-1" id="deviceList"></div>
            </div>

            <div class="glass p-5 rounded-2xl flex-shrink-0">
                <h3 class="text-[10px] font-bold text-blue-400 mb-3 uppercase tracking-widest">3. –¶–≤–µ—Ç –∫–æ—Ä–ø—É—Å–∞</h3>
                <div class="flex flex-wrap gap-2 items-center" id="colorPalette"></div>
            </div>

            <div class="glass p-5 rounded-2xl flex-shrink-0">
                <h3 class="text-[10px] font-bold text-blue-400 mb-3 uppercase tracking-widest">4. –ü–æ–ª–æ–∂–µ–Ω–∏–µ –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ</h3>
                <div class="grid grid-cols-2 gap-2" id="positionList"></div>
            </div>

            <button onclick="sendMockup()" id="sendBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 rounded-2xl font-bold text-white shadow-xl shadow-blue-900/30 transition-all transform active:scale-95 flex items-center justify-center gap-3 flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                –ü–û–î–ï–õ–ò–¢–¨–°–Ø
            </button>
        </div>

        <div class="lg:col-span-8 glass rounded-[2.5rem] flex items-center justify-center relative bg-slate-950 overflow-auto p-4" style="min-height: calc(100vh - 120px);">
            <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: linear-gradient(#3b82f6 1px, transparent 1px), linear-gradient(90deg, #3b82f6 1px, transparent 1px); background-size: 40px 40px;"></div>
            
            <div id="capture-area" class="perspective-container py-12">
                <div id="device-frame" class="relative shadow-[0_50px_100px_-20px_rgba(0,0,0,1)]">
                    <div id="notch" class="absolute left-1/2 -translate-x-1/2 bg-black z-20"></div>
                    <div id="screen" class="absolute top-0 left-0 w-full overflow-hidden bg-black" style="height: 100%;">
                        <div id="screen-bg" style="background-image: url('https://images.unsplash.com/photo-1616348436168-de43ad0db179?q=80&w=1000');"></div>
                    </div>
                    <div class="absolute inset-0 pointer-events-none z-30 bg-gradient-to-tr from-white/5 via-transparent to-transparent rounded-[inherit]"></div>
                    <div id="keyboard"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const devices = {
            // iPhone
            "iPhone 11":        { w: 278, h: 580, r: '40px', b: '10px', type: 'notch', category: 'iPhone' },
            "iPhone 12":        { w: 280, h: 590, r: '40px', b: '10px', type: 'notch', category: 'iPhone' },
            "iPhone 12 Pro":    { w: 280, h: 590, r: '40px', b: '10px', type: 'island', category: 'iPhone' },
            "iPhone 13":        { w: 290, h: 600, r: '42px', b: '10px', type: 'notch', category: 'iPhone' },
            "iPhone 13 Pro":    { w: 290, h: 600, r: '42px', b: '10px', type: 'island', category: 'iPhone' },
            "iPhone 13 Pro Max":{ w: 320, h: 660, r: '46px', b: '12px', type: 'island', category: 'iPhone' },
            "iPhone 14":        { w: 292, h: 605, r: '43px', b: '9px',  type: 'notch', category: 'iPhone' },
            "iPhone 14 Plus":   { w: 320, h: 665, r: '48px', b: '12px', type: 'notch', category: 'iPhone' },
            "iPhone 14 Pro":    { w: 295, h: 610, r: '46px', b: '8px',  type: 'island', category: 'iPhone' },
            "iPhone 14 Pro Max":{ w: 325, h: 670, r: '50px', b: '12px', type: 'island', category: 'iPhone' },
            "iPhone 15":        { w: 293, h: 608, r: '44px', b: '8px',  type: 'notch', category: 'iPhone' },
            "iPhone 15 Plus":   { w: 322, h: 668, r: '48px', b: '12px', type: 'notch', category: 'iPhone' },
            "iPhone 15 Pro":    { w: 295, h: 610, r: '48px', b: '7px',  type: 'island', category: 'iPhone' },
            "iPhone 15 Pro Max":{ w: 325, h: 670, r: '52px', b: '10px', type: 'island', category: 'iPhone' },
            "iPhone 16":        { w: 295, h: 615, r: '45px', b: '8px',  type: 'notch', category: 'iPhone' },
            "iPhone 16 Plus":   { w: 325, h: 675, r: '49px', b: '12px', type: 'notch', category: 'iPhone' },
            "iPhone 16 Pro":    { w: 298, h: 618, r: '48px', b: '7px',  type: 'island', category: 'iPhone' },
            "iPhone 16 Pro Max":{ w: 340, h: 700, r: '52px', b: '5px',  type: 'island', category: 'iPhone' },
            "iPhone 17 Pro Max":{ w: 345, h: 710, r: '54px', b: '4px',  type: 'island', category: 'iPhone' },
            
            // Samsung
            "Samsung Galaxy S24":       { w: 280, h: 600, r: '44px', b: '10px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S24+":      { w: 300, h: 630, r: '46px', b: '12px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S24 Ultra": { w: 320, h: 680, r: '48px', b: '12px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S23":       { w: 278, h: 598, r: '44px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S23+":      { w: 298, h: 628, r: '46px', b: '12px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S23 Ultra": { w: 318, h: 678, r: '48px', b: '12px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S22":       { w: 275, h: 595, r: '43px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S22+":      { w: 295, h: 625, r: '45px', b: '12px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy S22 Ultra": { w: 315, h: 675, r: '48px', b: '12px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy A54":       { w: 270, h: 580, r: '40px', b: '8px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy A53":       { w: 268, h: 578, r: '40px', b: '8px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy A34":       { w: 265, h: 570, r: '38px', b: '8px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy Z Fold 6":  { w: 310, h: 650, r: '32px', b: '10px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy Z Flip 6":  { w: 165, h: 310, r: '20px', b: '6px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy Note 20":   { w: 295, h: 630, r: '44px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy F15":       { w: 270, h: 575, r: '40px', b: '8px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy F25":       { w: 278, h: 590, r: '42px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy f25 5G":    { w: 282, h: 595, r: '43px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy M35":       { w: 275, h: 585, r: '40px', b: '8px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy M55":       { w: 288, h: 605, r: '42px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy C55":       { w: 285, h: 600, r: '41px', b: '9px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy M15":       { w: 268, h: 575, r: '40px', b: '8px', type: 'hole', category: 'Samsung' },
            "Samsung Galaxy M25":       { w: 276, h: 588, r: '41px', b: '8px', type: 'hole', category: 'Samsung' }
        };

        const colors = [
            // –ë–∞–∑–æ–≤—ã–µ
            { name: 'Titanium', nameRu: '–¢–∏—Ç–∞–Ω', hex: '#373737' },
            { name: 'Silver', nameRu: '–°–µ—Ä–µ–±—Ä–æ', hex: '#e2e2e2' },
            { name: 'Gold', nameRu: '–ó–æ–ª–æ—Ç–æ', hex: '#f5e3c7' },
            { name: 'Midnight', nameRu: '–ü–æ–ª–Ω–æ—á—å', hex: '#1c1c1e' },
            // –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞
            { name: 'Deep Purple', nameRu: '–ì–ª—É–±–æ–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', hex: '#4b3d54' },
            { name: 'Alpine Green', nameRu: '–ê–ª—å–ø–∏–π—Å–∫–∏–π –∑–µ–ª—ë–Ω—ã–π', hex: '#4f5d4e' },
            { name: 'Rose Pink', nameRu: '–†–æ–∑–æ–≤—ã–π', hex: '#e8a3b0' },
            { name: 'Ocean Blue', nameRu: '–ú–æ—Ä—Å–∫–æ–π —Å–∏–Ω–∏–π', hex: '#0066cc' },
            { name: 'Sunset Orange', nameRu: '–û—Ä–∞–Ω–∂–µ–≤—ã–π –∑–∞–∫–∞—Ç', hex: '#ff6b35' },
            { name: 'Forest Green', nameRu: '–õ–µ—Å–Ω–æ–π –∑–µ–ª—ë–Ω—ã–π', hex: '#2d5016' },
            { name: 'Burgundy', nameRu: '–ë–æ—Ä–¥–æ–≤—ã–π', hex: '#800020' },
            { name: 'Turquoise', nameRu: '–ë–∏—Ä—é–∑–æ–≤—ã–π', hex: '#40e0d0' },
            { name: 'Coral', nameRu: '–ö–æ—Ä–∞–ª–ª', hex: '#ff6f61' },
            { name: 'Cream', nameRu: '–ö—Ä–µ–º–æ–≤—ã–π', hex: '#fffdd0' },
            { name: 'Space Gray', nameRu: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Å–µ—Ä—ã–π', hex: '#2c3e50' }
        ];

        const positions = {
            "–†–æ–≤–Ω–æ": "rotateX(0deg) rotateY(0deg) rotateZ(0deg)",
            "–í –ª–µ–≤–æ–π —Ä—É–∫–µ": "rotateX(5deg) rotateY(25deg) rotateZ(-5deg)",
            "–í –ø—Ä–∞–≤–æ–π —Ä—É–∫–µ": "rotateX(5deg) rotateY(-25deg) rotateZ(5deg)",
            "–°–º–æ—Ç—Ä–∏—Ç –≤–ª–µ–≤–æ": "rotateY(30deg)",
            "–°–º–æ—Ç—Ä–∏—Ç –≤–ø—Ä–∞–≤–æ": "rotateY(-30deg)",
            "–°–º–æ—Ç—Ä–∏—Ç –≤–≤–µ—Ä—Ö": "rotateX(30deg)",
            "–°–º–æ—Ç—Ä–∏—Ç –≤–Ω–∏–∑": "rotateX(-30deg)",
            "–ù–∞–∫–ª–æ–Ω": "rotateX(15deg) rotateY(15deg) rotateZ(5deg)"
        };

        const frame = document.getElementById('device-frame');
        const screen = document.getElementById('screen');
        const notch = document.getElementById('notch');
        const screenBg = document.getElementById('screen-bg');
        const keyboard = document.getElementById('keyboard');
        // –¢–µ–∫—É—â–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        let currentContentFile = null; // File
        let currentContentType = null; // 'image' | 'video' | null
        let videoReady = false; // true –∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
        let readyRecordedBlob = null; // blob –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ

        // --- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ ---
        (function(){
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal" role="dialog">
                    <div class="modal-title" id="modalTitle"></div>
                    <div class="modal-body" id="modalBody"></div>
                    <div class="modal-actions" id="modalActions"></div>
                </div>`;
            document.body.appendChild(overlay);

            window.createModal = function(title, message, buttons){
                return new Promise(resolve => {
                    const t = overlay.querySelector('#modalTitle');
                    const b = overlay.querySelector('#modalBody');
                    const actions = overlay.querySelector('#modalActions');
                    t.textContent = title || '';
                    b.textContent = message || '';
                    actions.innerHTML = '';
                    buttons.forEach(btn => {
                        const el = document.createElement('button');
                        el.className = 'btn' + (btn.primary? ' primary':'');
                        el.textContent = btn.label || 'OK';
                        el.onclick = () => {
                            overlay.style.display = 'none';
                            try{ if (btn.onClick) btn.onClick(); }catch(e){console.error(e)}
                            resolve(btn.value !== undefined ? btn.value : btn.label);
                        };
                        actions.appendChild(el);
                    });
                    overlay.style.display = 'flex';
                });
            };

            window.showMessage = function(text){ return createModal('', text, [{label:'–û–ö', value:'ok', primary:true}]); };
            // –§—É–Ω–∫—Ü–∏—è —à–∞—Ä–∏–Ω–≥–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ (–≤—ã–∑–æ–≤ –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–ª–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞)
            window.sharePreparedBlob = async function(){
                if (!readyRecordedBlob) { showMessage('–ù–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞.'); return; }
                const outFile = new File([readyRecordedBlob], 'mockup-video.webm', { type: readyRecordedBlob.type || 'video/webm' });
                if (!navigator.share) { showMessage('–§—É–Ω–∫—Ü–∏—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
                try {
                    if (navigator.canShare && navigator.canShare({ files: [outFile] })) {
                        await navigator.share({ files: [outFile], title: '–ú–æ—ë –≤–∏–¥–µ–æ (–º–æ–∫–∞–ø)' });
                    } else {
                        await navigator.share({ title: '–ú–æ—ë –≤–∏–¥–µ–æ (–º–æ–∫–∞–ø)', text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –º–æ–∫–∞–ø-–≤–∏–¥–µ–æ' });
                    }
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∞—Ä–∏–Ω–≥–µ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:', err);
                    showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≥–æ—Ç–æ–≤—ã–º –≤–∏–¥–µ–æ.');
                }
            };
        })();

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ú–æ–¥–µ–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        let currentCategory = null;
        Object.keys(devices).forEach(name => {
            const device = devices[name];
            const category = device.category;
            
            let container = document.getElementById('deviceList');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (currentCategory !== category) {
                const header = document.createElement('div');
                header.className = "text-[9px] font-bold text-blue-300 mt-3 mb-2 px-2 uppercase tracking-widest";
                header.innerText = '‚îÅ‚îÅ ' + category + ' ‚îÅ‚îÅ';
                container.appendChild(header);
                currentCategory = category;
            }
            
            const btn = document.createElement('button');
            btn.className = "w-full text-left px-3 py-1.5 rounded-lg text-[10px] text-slate-300 border border-slate-800 hover:border-slate-600 transition-all";
            btn.innerText = name;
            btn.onclick = () => {
                document.querySelectorAll('#deviceList button').forEach(b => b.classList.remove('active-btn'));
                btn.classList.add('active-btn');
                const d = devices[name];
                frame.style.width = d.w + 'px';
                frame.style.height = d.h + 'px';
                frame.style.borderRadius = d.r;
                frame.style.borderWidth = d.b;
                
                // –û—á–∏—â–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                keyboard.innerHTML = '';
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ notch/hole –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if (d.type === 'island') {
                    notch.style.width = '85px';
                    notch.style.height = '25px';
                    notch.style.top = '10px';
                    notch.style.borderRadius = '20px';
                    notch.style.display = '';
                    screen.style.height = '100%';
                    screen.style.borderRadius = `calc(${d.r} - ${d.b})`;
                    keyboard.style.display = 'none';
                } else if (d.type === 'notch') {
                    notch.style.width = '110px';
                    notch.style.height = '28px';
                    notch.style.top = '0px';
                    notch.style.borderRadius = '0 0 15px 15px';
                    notch.style.display = '';
                    screen.style.height = '100%';
                    screen.style.borderRadius = `calc(${d.r} - ${d.b})`;
                    keyboard.style.display = 'none';
                } else if (d.type === 'hole') {
                    notch.style.width = '20px';
                    notch.style.height = '20px';
                    notch.style.top = '12px';
                    notch.style.left = '50%';
                    notch.style.borderRadius = '50%';
                    notch.style.display = '';
                    screen.style.height = '100%';
                    screen.style.borderRadius = `calc(${d.r} - ${d.b})`;
                    keyboard.style.display = 'none';
                } else if (d.type === 'laptop') {
                    notch.style.display = 'none';
                    // –î–ª—è –Ω–æ—É—Ç–±—É–∫–∞: —ç–∫—Ä–∞–Ω –∑–∞–Ω–∏–º–∞–µ—Ç 70% –≤—ã—Å–æ—Ç—ã, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ 30%
                    screen.style.height = '70%';
                    screen.style.borderRadius = `calc(${d.r} - ${d.b}) calc(${d.r} - ${d.b}) 0 0`;
                    keyboard.style.display = 'flex';
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏—à–∏
                    for (let i = 0; i < 35; i++) {
                        const key = document.createElement('div');
                        key.className = 'key';
                        keyboard.appendChild(key);
                    }
                }
            };
            container.appendChild(btn);
        });
        
        // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π iPhone –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        const firstBtn = document.querySelector('#deviceList button');
        if (firstBtn) firstBtn.click();

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¶–≤–µ—Ç–∞
        let midnightBtn = null;
        colors.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "w-7 h-7 rounded-full border-2 border-slate-700 hover:scale-110 transition-transform relative group";
            btn.style.backgroundColor = c.hex;
            btn.title = c.nameRu || c.name;
            btn.type = 'button';
            btn.onclick = () => {
                frame.style.borderColor = c.hex;
                document.querySelectorAll('#colorPalette button').forEach(b => b.classList.remove('ring-2', 'ring-blue-500'));
                btn.classList.add('ring-2', 'ring-blue-500');
            };
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ Midnight –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (c.name === 'Midnight') {
                midnightBtn = btn;
            }
            document.getElementById('colorPalette').appendChild(btn);
        });
        
        // –í—ã–±–∏—Ä–∞–µ–º Midnight (—á–µ—Ä–Ω—ã–π) –∫–∞–∫ —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (midnightBtn) {
            frame.style.borderColor = '#1c1c1e';
            midnightBtn.classList.add('ring-2', 'ring-blue-500');
        }

        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–≤–æ–µ–≥–æ —Ü–≤–µ—Ç–∞
        const customColorContainer = document.createElement('div');
        customColorContainer.className = "flex items-center gap-1";
        
        const customColorPicker = document.createElement('input');
        customColorPicker.type = 'color';
        customColorPicker.id = 'customColorPicker';
        customColorPicker.className = "w-7 h-7 rounded-md border-2 border-slate-700 cursor-pointer hover:border-slate-500 transition-all";
        customColorPicker.style.padding = '2px';
        customColorPicker.value = '#3b82f6';
        
        customColorContainer.appendChild(customColorPicker);
        document.getElementById('colorPalette').appendChild(customColorContainer);
        
        // HEX input —Å–ø—Ä–∞–≤–∞
        const hexInput = document.createElement('input');
        hexInput.type = 'text';
        hexInput.placeholder = 'HEX';
        hexInput.className = "w-16 text-[9px] bg-slate-900/30 border border-slate-800 rounded-lg px-2 py-1 outline-none text-white placeholder-slate-500 uppercase font-mono";
        hexInput.maxLength = '7';
        hexInput.value = '#3b82f6';
        hexInput.style.marginLeft = 'auto';
        document.getElementById('colorPalette').appendChild(hexInput);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è color picker
        customColorPicker.addEventListener('change', function(e) {
            const color = e.target.value.toUpperCase();
            frame.style.borderColor = color;
            hexInput.value = color;
            
            document.querySelectorAll('#colorPalette button').forEach(b => {
                b.classList.remove('ring-2', 'ring-blue-500');
            });
        });
        
        customColorPicker.addEventListener('input', function(e) {
            const color = e.target.value.toUpperCase();
            frame.style.borderColor = color;
            hexInput.value = color;
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è HEX input
        hexInput.addEventListener('input', function(e) {
            let hex = e.target.value.toUpperCase();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º # –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (hex && !hex.startsWith('#')) {
                hex = '#' + hex;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å HEX –∫–æ–¥–∞
            if (/^#[0-9A-F]{6}$/.test(hex)) {
                frame.style.borderColor = hex;
                customColorPicker.value = hex;
                if (!e.target.value.startsWith('#')) {
                    e.target.value = hex;
                }
            }
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å color picker
        hexInput.addEventListener('blur', function(e) {
            if (!e.target.value.startsWith('#')) {
                e.target.value = '#' + e.target.value;
            }
        });

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ü–æ–∑–∏—Ü–∏–∏ + –∫–æ–Ω—Ç—Ä–æ–ª –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏
        const positionListEl = document.getElementById('positionList');
        // –ö–æ–Ω—Ç—Ä–æ–ª –ø–æ–ª–∑—É–Ω–∫–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–∑–∏—Ü–∏–∏)
        const positionControl = document.createElement('div');
        positionControl.id = 'positionControl';
        positionControl.className = 'mt-2';
        positionControl.style.display = 'none';
        positionControl.innerHTML = `
            <div class="flex items-center gap-2">
                <label id="positionLabel" class="text-[10px] text-slate-300">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å</label>
                <input id="positionRange" type="range" min="0" max="200" value="100" step="1" class="flex-1">
                <span id="positionValue" class="text-[10px] text-slate-400">100%</span>
            </div>
        `;
        positionListEl.parentNode.insertBefore(positionControl, positionListEl.nextSibling);

        let currentBaseTransform = '';
        function applyScaledTransform(baseTransform, percent) {
            // scale numeric degree values inside rotateX/Y/Z(...) by percent/100
            const scale = percent / 100;
            const scaled = baseTransform.replace(/rotate([XYZ])\((-?\d+(?:\.\d+)?)deg\)/g, (m, axis, val) => {
                const num = parseFloat(val);
                const scaledNum = +(num * scale).toFixed(2);
                return `rotate${axis}(${scaledNum}deg)`;
            });
            frame.style.transform = scaled;
        }

        // –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ –ø–æ–∑–∏—Ü–∏–π
        Object.keys(positions).forEach(pos => {
            const btn = document.createElement('button');
            btn.className = "px-2 py-1.5 rounded-lg text-[9px] bg-slate-800/50 border border-slate-700 hover:bg-slate-700 transition-all";
            btn.innerText = pos;
            btn.onclick = () => {
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                document.querySelectorAll('#positionList button').forEach(b => b.classList.remove('active-btn'));
                btn.classList.add('active-btn');

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—É—é —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª
                currentBaseTransform = positions[pos];
                if (pos === '–†–æ–≤–Ω–æ') {
                    // –¥–ª—è —Ä–æ–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª –∏ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º transform
                    positionControl.style.display = 'none';
                    frame.style.transform = currentBaseTransform;
                } else {
                    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                    positionControl.style.display = '';
                    document.getElementById('positionRange').value = 100;
                    document.getElementById('positionValue').innerText = '100%';
                    applyScaledTransform(currentBaseTransform, 100);
                }
            };
            positionListEl.appendChild(btn);
            if(pos === "–†–æ–≤–Ω–æ") {
                btn.classList.add('active-btn');
                // –¥–ª—è –†–æ–≤–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
                currentBaseTransform = positions[pos];
                positionControl.style.display = 'none';
                frame.style.transform = currentBaseTransform;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª–∑—É–Ω–∫–∞
        const range = document.getElementById('positionRange');
        const valueLabel = document.getElementById('positionValue');
        range.addEventListener('input', function() {
            const v = parseInt(this.value, 10);
            valueLabel.innerText = v + '%';
            if (currentBaseTransform) applyScaledTransform(currentBaseTransform, v);
        });

        // Drag and Drop –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
        const dropZone = document.getElementById('dropZone');
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ premium —Å—Ç–∞—Ç—É—Å–∞
        const isPremium = localStorage.getItem('premium') === 'yes';
        const contentUpload = document.getElementById('contentUpload');
        const dropZoneText = document.getElementById('dropZoneText');
        const premiumMessage = document.getElementById('premiumMessage');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º accept –∞—Ç—Ä–∏–±—É—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç premium —Å—Ç–∞—Ç—É—Å–∞
        if (isPremium) {
            contentUpload.accept = 'image/*,video/*';
            dropZoneText.textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ (–¥–æ 20 —Å–µ–∫) –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ';
            premiumMessage.style.display = 'none';
        } else {
            contentUpload.accept = 'image/*';
            dropZoneText.textContent = '–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ';
            premiumMessage.style.display = 'block';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
                currentContentFile = file;
                if (file.type.startsWith('image/')) {
                    currentContentType = 'image';
                    videoReady = true;
                    loadImage(file);
                } else if (file.type.startsWith('video/') && isPremium) {
                    currentContentType = 'video';
                    videoReady = false;
                    loadVideo(file);
                }
            }
        }
        
        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (ev) => screenBg.style.backgroundImage = `url('${ev.target.result}')`;
            reader.readAsDataURL(file);
        }

        function loadVideo(file) {
            // file: File
            currentContentFile = file;
            currentContentType = 'video';
            videoReady = false;
            const video = document.createElement('video');
            video.preload = 'metadata';
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            video.onloadedmetadata = function() {
                if (video.duration > 20) {
                    showMessage('–í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 20 —Å–µ–∫—É–Ω–¥. –í–∞—à–µ –≤–∏–¥–µ–æ: ' + Math.round(video.duration) + ' —Å–µ–∫—É–Ω–¥.');
                    currentContentFile = null;
                    currentContentType = null;
                    videoReady = false;
                    return;
                }
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –≤ dataURL –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–≤—å—é
                const reader = new FileReader();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                screenBg.style.backgroundImage = 'none';
                screen.innerHTML = `<div id="contentPreloader" class="flex items-center justify-center w-full h-full"><div class="spinner"></div></div>`;
                // –¥–æ–±–∞–≤–∏–º –ø—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è .spinner, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
                reader.onload = (ev) => {
                    // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –Ω–∞ –≤–∏–¥–µ–æ
                    screen.innerHTML = `<video id="previewVideo" style="width:100%; height:100%; object-fit:cover;" src="${ev.target.result}" autoplay loop muted playsinline></video>`;
                    videoReady = true;
                    // –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ "–≥–æ—Ç–æ–≤–æ–≥–æ" –≤–∏–¥–µ–æ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞—Ä–∏–Ω–≥–∞
                    setTimeout(() => {
                        const pv = document.getElementById('previewVideo');
                        if (pv) {
                            try { prepareRenderedVideoInBackground(pv); } catch(e){ console.error('prepareRenderedVideoInBackground error', e);}    
                        }
                    }, 300);
                };
                reader.readAsDataURL(file);
            };
            video.src = URL.createObjectURL(file);
        }

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –≤–∏–¥–µ–æ (—Ä–µ–Ω–¥–µ—Ä –Ω–∞ canvas + MediaRecorder) –≤ —Ñ–æ–Ω–µ
        async function prepareRenderedVideoInBackground(preview){
            try {
                readyRecordedBlob = null;
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º canvas –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º —Ñ—Ä–µ–π–º–∞
                const frameRect = frame.getBoundingClientRect();
                const w = Math.ceil(frameRect.width);
                const h = Math.ceil(frameRect.height);
                const canvas = document.createElement('canvas');
                const dpr = Math.max(1, window.devicePixelRatio || 1);
                canvas.width = w * dpr;
                canvas.height = h * dpr;
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);

                let rafId = null;
                function drawFrame(){
                    // clear
                    ctx.fillStyle = '#0b0f19';
                    ctx.fillRect(0,0,w,h);
                    // draw video centered and cover
                    let vw = preview.videoWidth || w;
                    let vh = preview.videoHeight || h;
                    const ratio = Math.max(w / vw, h / vh);
                    const dw = vw * ratio;
                    const dh = vh * ratio;
                    const dx = (w - dw) / 2;
                    const dy = (h - dh) / 2;
                    try { ctx.drawImage(preview, dx, dy, dw, dh); } catch(e){}
                    // draw rounded frame border
                    const br = parseInt(getComputedStyle(frame).borderRadius) || 20;
                    const bw = parseInt(getComputedStyle(frame).borderWidth) || 10;
                    ctx.lineWidth = bw;
                    ctx.strokeStyle = getComputedStyle(frame).borderColor || '#000';
                    roundRect(ctx, bw/2, bw/2, w-bw, h-bw, br);
                    rafId = requestAnimationFrame(drawFrame);
                }

                drawFrame();

                const stream = canvas.captureStream(30);
                let options = { mimeType: 'video/webm;codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm;codecs=vp8' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
                const recorder = new MediaRecorder(stream, options);
                const chunks = [];
                recorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };
                recorder.start(1000);

                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è —Å –Ω–∞—á–∞–ª–∞
                try { preview.currentTime = 0; await preview.play().catch(()=>{}); } catch(e){}

                const maxDur = Math.min(preview.duration || 20, 20);
                await new Promise(res => {
                    const t = setTimeout(()=>{
                        try{ if (recorder.state === 'recording') recorder.stop(); }catch(e){}
                    }, Math.ceil(maxDur*1000)+300);
                    recorder.onstop = () => { clearTimeout(t); res(); };
                });

                cancelAnimationFrame(rafId);
                const blob = new Blob(chunks, { type: chunks[0]?.type || options.mimeType || 'video/webm' });
                // –û—Å—Ç–∞–Ω–æ–≤–∏–º tracks
                try { stream.getTracks().forEach(t=>t.stop()); } catch(e){}
                readyRecordedBlob = blob;
                console.log('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –≥–æ—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ (—Ñ–æ–Ω). size=', blob.size);
            } catch(e){
                console.error('–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –≤–∏–¥–µ–æ:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ input
        contentUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                currentContentFile = file;
                if (file.type.startsWith('image/')) {
                    currentContentType = 'image';
                    videoReady = true;
                    loadImage(file);
                } else if (file.type.startsWith('video/')) {
                    if (!isPremium) {
                        showMessage('–¢—Ä–µ–±—É–µ—Ç—Å—è Premium –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ');
                        return;
                    }
                    currentContentType = 'video';
                    videoReady = false;
                    loadVideo(file);
                }
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
        async function sendMockup() {
            const btn = document.getElementById('sendBtn');

            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç - –≤–∏–¥–µ–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –≤–∏–¥–µ–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è Premium)
            if (currentContentType === 'video') {
                if (!isPremium) { await showMessage('–¢—Ä–µ–±—É–µ—Ç—Å—è Premium –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–∏–¥–µ–æ'); return; }
                if (!videoReady) { await showMessage('–í–∏–¥–µ–æ –µ—â—ë –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.'); return; }

                // –ï—Å–ª–∏ –≥–æ—Ç–æ–≤—ã–π blob —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –≤ —Ñ–æ–Ω–µ ‚Äî —Å—Ä–∞–∑—É —à–∞—Ä–∏–º (–≤ —Ç–æ–º –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∂–µ—Å—Ç–µ)
                if (readyRecordedBlob) {
                    try {
                        const outFile = new File([readyRecordedBlob], 'mockup-video.webm', { type: readyRecordedBlob.type || 'video/webm' });
                        if (!navigator.share) { await showMessage('–§—É–Ω–∫—Ü–∏—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
                        if (navigator.canShare && navigator.canShare({ files: [outFile] })) {
                            await navigator.share({ files: [outFile], title: '–ú–æ—ë –≤–∏–¥–µ–æ (–º–æ–∫–∞–ø)' });
                        } else {
                            await navigator.share({ title: '–ú–æ—ë –≤–∏–¥–µ–æ (–º–æ–∫–∞–ø)', text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –º–æ–∫–∞–ø-–≤–∏–¥–µ–æ' });
                        }
                        return;
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∞—Ä–∏–Ω–≥–µ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:', err);
                        await showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≥–æ—Ç–æ–≤—ã–º –≤–∏–¥–µ–æ.');
                        return;
                    }
                }

                btn.disabled = true;
                btn.dataset._origBg = btn.style.backgroundColor || '';
                btn.dataset._origCursor = btn.style.cursor || '';
                btn.classList.add('opacity-70');
                btn.style.backgroundColor = '#9ca3af';
                btn.style.cursor = 'not-allowed';
                btn.innerHTML = `<span class="animate-spin">üåÄ</span> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ...`;

                try {
                    // –ù–∞–π–¥—ë–º –≤–∏–¥–µ–æ-–ø—Ä–µ–≤—å—é –≤ —ç–∫—Ä–∞–Ω–µ
                    let preview = document.getElementById('previewVideo');
                    let createdTemp = false;
                    if (!preview) {
                        preview = document.createElement('video');
                        preview.src = URL.createObjectURL(currentContentFile);
                        preview.muted = true;
                        preview.playsInline = true;
                        createdTemp = true;
                    }

                    // –û–∂–∏–¥–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é (—á—Ç–æ–±—ã videoWidth/videoHeight –±—ã–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω—ã)
                    preview.muted = true;
                    try {
                        await new Promise(res => {
                            if (preview.readyState >= 2) return res();
                            preview.addEventListener('canplay', () => res(), { once: true });
                        });
                    } catch(e) {}
                    try { await preview.play().catch(()=>{}); } catch(e) {}

                    const frameRect = frame.getBoundingClientRect();
                    const w = Math.ceil(frameRect.width);
                    const h = Math.ceil(frameRect.height);

                    const canvas = document.createElement('canvas');
                    const dpr = Math.max(1, window.devicePixelRatio || 1);
                    canvas.width = w * dpr;
                    canvas.height = h * dpr;
                    canvas.style.width = w + 'px';
                    canvas.style.height = h + 'px';
                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);

                    // –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫–∞–¥—Ä–∞ (–≤–∫–ª—é—á–∞—è —Ä–∞–º–∫—É)
                    function drawFrame() {
                        // clear
                        ctx.fillStyle = '#0b0f19';
                        ctx.fillRect(0,0,w,h);
                        // draw video centered and cover
                        let vw = preview.videoWidth || w;
                        let vh = preview.videoHeight || h;
                        const ratio = Math.max(w / vw, h / vh);
                        const dw = vw * ratio;
                        const dh = vh * ratio;
                        const dx = (w - dw) / 2;
                        const dy = (h - dh) / 2;
                        try { ctx.drawImage(preview, dx, dy, dw, dh); } catch(e) {}
                        // draw rounded frame border
                        const br = parseInt(getComputedStyle(frame).borderRadius) || 20;
                        const bw = parseInt(getComputedStyle(frame).borderWidth) || 10;
                        ctx.lineWidth = bw;
                        ctx.strokeStyle = getComputedStyle(frame).borderColor || '#000';
                        roundRect(ctx, bw/2, bw/2, w-bw, h-bw, br);
                        ctx.stroke();
                    }

                    function roundRect(ctx, x, y, width, height, radius) {
                        ctx.beginPath();
                        ctx.moveTo(x + radius, y);
                        ctx.arcTo(x + width, y, x + width, y + radius, radius);
                        ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                        ctx.arcTo(x, y + height, x, y + height - radius, radius);
                        ctx.arcTo(x, y, x + radius, y, radius);
                        ctx.closePath();
                    }

                    const stream = canvas.captureStream(30);
                    let options = { mimeType: 'video/webm;codecs=vp9' };
                    try {
                        if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm;codecs=vp8' };
                        if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
                    } catch(e) { options = {}; }
                    let recorder;
                    try { recorder = options && options.mimeType ? new MediaRecorder(stream, options) : new MediaRecorder(stream); } catch(err) { recorder = new MediaRecorder(stream); }
                    const chunks = [];
                    recorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };

                    // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ –Ω–µ –≤ loop –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ (–∏–Ω–∞—á–µ onended –Ω–µ –≤—ã–∑–æ–≤–µ—Ç—Å—è), —Å–æ—Ö—Ä–∞–Ω–∏–º —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                    const origLoop = preview.loop;
                    try { preview.loop = false; } catch(e){}

                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–Ω–∞—á–∞–ª–∞, —á—Ç–æ–±—ã canvas —É–∂–µ –∏–º–µ–ª —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫ –º–æ–º–µ–Ω—Ç—É —Å—Ç–∞—Ä—Ç–∞ –∑–∞–ø–∏—Å–∏
                    let rafId;
                    const drawLoop = () => { drawFrame(); rafId = requestAnimationFrame(drawLoop); };
                    drawLoop();

                    // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞, —á—Ç–æ–±—ã –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –æ—Ç–æ–±—Ä–∞–∑–∏–ª—Å—è
                    await new Promise(res => setTimeout(res, 120));

                    try { recorder.start(200); } catch(e) { try { recorder.start(); } catch(e2) { console.error('recorder.start failed', e2); } }

                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –≤–∏–¥–µ–æ
                    await new Promise(resolve => {
                        let resolved = false;
                        const onEnd = () => { if (!resolved) { resolved = true; resolve(); } };
                        preview.onended = onEnd;
                        // –ù–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ preview.duration –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, —Å—Ç–∞–≤–∏–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
                        const maxDur = Math.min(preview.duration || 20, 20);
                        setTimeout(() => { if (!resolved) { resolved = true; resolve(); } }, Math.ceil(maxDur*1000)+500);
                    });

                    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –ø—Ä–æ–º–∏—Å –¥–æ –≤—ã–∑–æ–≤–∞ stop, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–π–º–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ onstop
                    const stopPromise = new Promise(res => recorder.onstop = () => res(new Blob(chunks, { type: chunks[0]?.type || options.mimeType || 'video/webm' })));
                    // –û—Å—Ç–∞–Ω–æ–≤–∏–º –∑–∞–ø–∏—Å—å –∏ —Ü–∏–∫–ª —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                    try { recorder.stop(); } catch(e) { console.warn('recorder.stop error', e); }
                    cancelAnimationFrame(rafId);
                    const recordedBlob = await stopPromise;
                    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º loop —É preview
                    try { preview.loop = origLoop; } catch(e){}
                    // –û—Å—Ç–∞–Ω–æ–≤–∏–º —Ç—Ä–µ–∫–∏ —Å—Ç—Ä–∏–º–∞, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
                    try { stream.getTracks().forEach(t => t.stop()); } catch(e) {}

                    // –û—á–∏—Å—Ç–∫–∞
                    if (createdTemp) {
                        preview.pause();
                        preview.src = '';
                    }

                    // –°–æ—Ö—Ä–∞–Ω–∏–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –∏ –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è (–≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ sendMockup)
                    // –ü—Ä–æ–≤–µ—Ä–∏–º —Ä–∞–∑–º–µ—Ä blob ‚Äî –µ—Å–ª–∏ –æ–Ω –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π, —Å—á–∏—Ç–∞–µ–º –∑–∞–ø–∏—Å—å –Ω–µ—É–¥–∞—á–Ω–æ–π
                    if (!recordedBlob || (recordedBlob.size || 0) < 1000) {
                        console.error('–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π blob —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π –∏–ª–∏ –ø—É—Å—Ç–æ–π, size=', recordedBlob?.size);
                        await showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
                    } else {
                        readyRecordedBlob = recordedBlob;
                        try {
                            const outFile = new File([readyRecordedBlob], 'mockup-video.webm', { type: readyRecordedBlob.type || 'video/webm' });
                            if (!navigator.share) { await showMessage('–§—É–Ω–∫—Ü–∏—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ'); }
                            else if (navigator.canShare && navigator.canShare({ files: [outFile] })) {
                                try { await navigator.share({ files: [outFile], title: '–ú–æ—ë –≤–∏–¥–µ–æ (–º–æ–∫–∞–ø)' }); }
                                catch (err) { console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∞—Ä–∏–Ω–≥–µ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:', err); await showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≥–æ—Ç–æ–≤—ã–º –≤–∏–¥–µ–æ.'); }
                            } else {
                                try { await navigator.share({ title: '–ú–æ—ë –≤–∏–¥–µ–æ (–º–æ–∫–∞–ø)', text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –º–æ–∫–∞–ø-–≤–∏–¥–µ–æ' }); }
                                catch (err) { console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —à–∞—Ä–∏–Ω–≥–µ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ (—Ç–µ–∫—Å—Ç):', err); }
                            }
                        } catch (err) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —à–∞—Ä–∏–Ω–≥–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:', err);
                            await showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≥–æ—Ç–æ–≤—ã–º –≤–∏–¥–µ–æ.');
                        }
                    }

                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ:', e);
                        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –≤–∏–¥–µ–æ');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg> –ü–û–î–ï–õ–ò–¢–¨–°–Ø`;
                    btn.style.backgroundColor = btn.dataset._origBg || '';
                    btn.style.cursor = btn.dataset._origCursor || '';
                    btn.classList.remove('opacity-70');
                    delete btn.dataset._origBg;
                    delete btn.dataset._origCursor;
                }

                return;
            }

            btn.disabled = true;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∏–ª—å –∏ –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–π
            btn.dataset._origBg = btn.style.backgroundColor || '';
            btn.dataset._origCursor = btn.style.cursor || '';
            btn.classList.add('opacity-70');
            btn.style.backgroundColor = '#9ca3af';
            btn.style.cursor = 'not-allowed';
            btn.innerHTML = `<span class="animate-spin">üåÄ</span> –û—Ç–ø—Ä–∞–≤–∫–∞...`;

            try {
                // –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä–∏–º –æ–±–ª–∞—Å—Ç—å –∑–∞—Ö–≤–∞—Ç–∞
                const capture = document.getElementById('capture-area');
                const frameRect = frame.getBoundingClientRect();
                // –°–æ—Ö—Ä–∞–Ω–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                const origStyles = {
                    width: capture.style.width || '',
                    height: capture.style.height || '',
                    padding: capture.style.padding || '',
                    display: capture.style.display || '',
                    alignItems: capture.style.alignItems || '',
                    justifyContent: capture.style.justifyContent || ''
                };
                // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Ä–∞–∑–º–µ—Ä—ã, —á—Ç–æ–±—ã –≤–æ–∫—Ä—É–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –±—ã–ª –æ—Ç—Å—Ç—É–ø 40px
                capture.style.display = 'flex';
                capture.style.alignItems = 'center';
                capture.style.justifyContent = 'center';
                capture.style.width = (Math.ceil(frameRect.width) + 80) + 'px';
                capture.style.height = (Math.ceil(frameRect.height) + 80) + 'px';
                capture.style.padding = '40px';

                // –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ—Ä–µ–∑ html2canvas
                const canvas = await html2canvas(capture, {
                    backgroundColor: '#0b0f19',
                    scale: 2,
                    useCORS: true
                });

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ (–¥–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ blob –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
                capture.style.width = origStyles.width;
                capture.style.height = origStyles.height;
                capture.style.padding = origStyles.padding;
                capture.style.display = origStyles.display;
                capture.style.alignItems = origStyles.alignItems;
                capture.style.justifyContent = origStyles.justifyContent;

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ blob –¥–ª—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
                canvas.toBlob(async (blob) => {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É Share API
                        if (navigator.share) {
                            // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ñ–∞–π–ª–æ–º
                            let shareSuccess = false;
                            
                            try {
                                const file = new File([blob], 'mockup.png', { type: 'image/png' });
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –±—ã—Ç—å –ø–æ–¥–µ–ª–µ–Ω —Ñ–∞–π–ª
                                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                    await navigator.share({
                                        files: [file],
                                        title: '–ú–æ–π –º–æ–∫–∞–ø'
                                    });
                                    shareSuccess = true;
                                }
                            } catch (fileError) {
                                console.log('–§–∞–π–ª –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–µ–ª–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±');
                            }
                            
                            // –ï—Å–ª–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ñ–∞–π–ª–æ–º –Ω–µ —É–¥–∞–ª–æ—Å—å, –¥–µ–ª–∏–º—Å—è –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–º
                            if (!shareSuccess) {
                                try {
                                    await navigator.share({
                                        title: '–ú–æ–π –º–æ–∫–∞–ø',
                                        text: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ–π –º–æ–∫–∞–ø!'
                                    });
                                } catch (textError) {
                                    if (textError.name !== 'AbortError') {
                                        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è:', textError);
                                    }
                                }
                            }
                        } else {
                            showMessage('–§—É–Ω–∫—Ü–∏—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                        }
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞:', e);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg> –ü–û–î–ï–õ–ò–¢–¨–°–Ø`;
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥
                        btn.style.backgroundColor = btn.dataset._origBg || '';
                        btn.style.cursor = btn.dataset._origCursor || '';
                        btn.classList.remove('opacity-70');
                        delete btn.dataset._origBg;
                        delete btn.dataset._origCursor;
                    }
                }, 'image/png');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ:', e);
                showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–æ–∫–∞–ø–∞");
                btn.disabled = false;
                btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg> –ü–û–î–ï–õ–ò–¢–¨–°–Ø`;
            }
        }
    </script>
</body>
</html>