<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Загрузка</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: linear-gradient(160deg, #04002b, #0b0070);
      color: #d9d9d9;
      font-family: Arial, sans-serif;
      font-size: 20px;
    }

    .centered {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 20px;
    }

    /* Карточка */
    .card {
      background: rgba(37, 24, 151, 0.25);
      backdrop-filter: blur(8px);
      border-radius: 20px;
      padding: 30px 25px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    .card.animating {
      animation: fadeIn 0.35s ease;
    }

    h1 {
      margin: 20px 0 30px;
      font-size: 28px;
      white-space: pre-line;
    }

    button {
      background: linear-gradient(135deg, #3a2bff, #6a5cff);
      color: #d9d9d9;
      border: none;
      padding: 14px 24px;
      margin: 12px 0;
      border-radius: 14px;
      font-size: 24px;
      cursor: pointer;
      width: 100%;
    }

    button.animating {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    button.animating:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
    }

    .token-container {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: rgba(37, 24, 151, 0.6);
      padding: 10px 14px;
      border-radius: 14px;
      user-select: all;
      font-size: 16px;
      max-width: 100%;
      word-break: break-all;
      text-align: center;
    }

    .copy-btn {
      background: #3a2bff;
      border: none;
      color: #d9d9d9;
      cursor: pointer;
      font-size: 16px;
      padding: 8px 14px;
      border-radius: 12px;
      user-select: none;
      white-space: nowrap;
      width: auto;
    }

    .support-text {
      margin-top: 25px;
      font-size: 18px;
    }

    .support-text a {
      color: #ffffff;
      text-decoration: underline;
    }

    /* ===== PRELOADER ===== */
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid rgba(255,255,255,0.2);
      border-top-color: #6a5cff;
      border-radius: 50%;
      margin: 0 auto;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Notification styles */
    #notification {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
      font-size: 16px;
      text-align: center;
      max-width: 80%;
    }

    /* Modal styles */
    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      align-items: center;
      justify-content: center;
    }

    #modal .modal-content {
      background: rgba(37, 24, 151, 0.25);
      backdrop-filter: blur(8px);
      border-radius: 20px;
      padding: 30px 25px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      text-align: center;
    }

    #modal-message {
      margin-bottom: 20px;
      font-size: 24px;
      white-space: pre-line;
    }

    #modal-ok {
      width: auto;
      min-width: 120px;
    }

    /* Mobile optimizations: Increase sizes */
    @media screen and (max-width: 768px) {
      html, body {
        font-size: 28px; /* Further increase base font size */
      }

      .centered {
        padding: 20px; /* Restore padding to show edges */
      }

      .card {
        padding: 40px 20px; /* Adjust padding, less horizontal for wider feel */
        max-width: 90%;
        margin: 0 auto;
        min-height: auto; /* Not full height */
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      }

      h1 {
        font-size: 42px; /* Larger heading */
        margin: 30px 0 40px;
      }

      button {
        padding: 20px 30px; /* Larger buttons */
        font-size: 32px;
        border-radius: 20px;
        margin: 18px 0;
      }

      .token-container {
        font-size: 24px; /* Larger token text */
        padding: 14px 18px;
        border-radius: 18px;
        gap: 14px;
      }

      .copy-btn {
        font-size: 24px;
        padding: 12px 18px;
        border-radius: 16px;
      }

      .support-text {
        font-size: 26px; /* Larger support text */
        margin-top: 35px;
      }

      .loader {
        width: 70px; /* Larger loader */
        height: 70px;
        border-width: 7px;
      }

      #notification {
        font-size: 24px; /* Larger notification text */
        padding: 14px 26px;
        max-width: 90%; /* Wider on mobile */
      }

      #modal-message {
        font-size: 32px;
      }

      #modal-ok {
        padding: 18px 28px;
        font-size: 28px;
      }
    }
  </style>
</head>

<body>
  <div id="notification"></div>
  <div class="centered">
    <div class="card">
      <div class="loader"></div>
      <h1 id="message">Идет загрузка... || Loading...</h1>
      <div id="buttons"></div>
    </div>
  </div>

  <div id="modal">
    <div class="modal-content">
      <p id="modal-message"></p>
      <button id="modal-ok">OK</button>
    </div>
  </div>

  <!-- JS НИЖЕ — БЕЗ ИЗМЕНЕНИЙ -->
  <script type="module">
    // --- security.js ---
    import { texpereriv, blockedTokens } from './security.js';

    const botToken = '6537497957:AAGZS4adwPVJSlx16YCCDrKjO96rDK7ZstI';
    const channelUsername = '@Nicknaymes2bot';
    const redirectUrl = 'main.html';

    let userLang = localStorage.getItem('lang');
    
    const text = {
      ru: {
        loading: 'Идет загрузка...',
        blocked: 'Ваш аккаунт заблокирован.',
        support: 'Служба поддержки: @',
        supportBot: 'Clickerstart_bot',
        maintenance: 'Технический перерыв!',
        soon: 'Скоро мы начнем технический перерыв!',
        subscribe: 'Подпишитесь на канал для продолжения!',
        checkSubscription: 'Проверить подписку'
      },
      en: {
        loading: 'Loading...',
        blocked: 'Your account is blocked.',
        support: 'Support service: @',
        supportBot: 'Clickerstart_bot',
        maintenance: 'Technical maintenance!',
        soon: 'Technical maintenance will start soon.',
        subscribe: 'Subscribe to the channel to continue!',
        checkSubscription: 'Check subscription'
      }
    };

    const messageEl = document.getElementById('message');
    const buttonsEl = document.getElementById('buttons');
    const loaderEl = document.querySelector('.loader');
    const cardEl = document.querySelector('.card');
    const notificationEl = document.getElementById('notification');
    const modalEl = document.getElementById('modal');
    const modalMessageEl = document.getElementById('modal-message');
    const modalOkBtn = document.getElementById('modal-ok');
    let userToken = null;
    let modalResolve = null;

    modalOkBtn.onclick = () => {
      modalEl.style.display = 'none';
      if (modalResolve) {
        modalResolve();
        modalResolve = null;
      }
    };

    function showNotification(message) {
      notificationEl.textContent = message;
      notificationEl.style.display = 'block';
      setTimeout(() => {
        notificationEl.style.display = 'none';
      }, 3000); // Hide after 3 seconds
    }

    function showModal(message) {
      modalMessageEl.textContent = message;
      modalEl.style.display = 'flex';
      return new Promise(resolve => {
        modalResolve = resolve;
      });
    }

    function toggleAnimations() {
      const animationsEnabled = localStorage.getItem('animations') === 'yes';
      if (animationsEnabled) {
        cardEl.classList.add('animating');
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => btn.classList.add('animating'));
      } else {
        cardEl.classList.remove('animating');
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => btn.classList.remove('animating'));
      }
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          showNotification('Ваш токен скопирован!\nYour token copied!');
          const copyBtn = document.querySelector('.copy-btn');
          if (copyBtn) copyBtn.textContent = 'Скопировано! || Copied!';
        }, () => {
          showNotification('Не удалось скопировать токен.');
        });
      } else {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showNotification('Ваш токен скопирован!\nYour token copied!');
          const copyBtn = document.querySelector('.copy-btn');
          if (copyBtn) copyBtn.textContent = 'Скопировано! || Copied!';
        } catch {
          showNotification('Не удалось скопировать токен.');
        }
        document.body.removeChild(textArea);
      }
    }

    function createTokenContainer() {
      const tokenContainer = document.createElement('div');
      tokenContainer.className = 'token-container';

      const tokenText = document.createElement('span');
      tokenText.textContent = userToken || 'нет токена';
      tokenContainer.appendChild(tokenText);

      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.textContent = 'Скопировать || Copy';
      copyBtn.onclick = () => copyToClipboard(userToken);
      tokenContainer.appendChild(copyBtn);

      return tokenContainer;
    }

    function createSupportText() {
      const supportDiv = document.createElement('div');
      supportDiv.className = 'support-text';
      supportDiv.innerHTML = `${text[userLang].support}<a href="https://t.me/${text[userLang].supportBot}" target="_blank">Clickerstart_bot</a>`;
      return supportDiv;
    }

    function createSubscriptionScreen(isFake = false) {
      messageEl.textContent = text[userLang].subscribe;
      buttonsEl.innerHTML = '';
      const subscribeButton = document.createElement('button');
      subscribeButton.textContent = text[userLang].checkSubscription;
      subscribeButton.onclick = isFake ? fakeCheckSubscription : checkSubscription;
      buttonsEl.appendChild(subscribeButton);
      buttonsEl.appendChild(createSupportText());
    }

    function showBlockedScreen() {
      messageEl.textContent = text[userLang].blocked;
      buttonsEl.innerHTML = '';
      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
    }

    function showMaintenanceScreen() {
      loaderEl.style.display = 'none';
      messageEl.textContent = text[userLang].maintenance;
      buttonsEl.innerHTML = '';
      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
    }

    function generateToken(length = 16) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < length; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    async function checkSubscription() {
      try {
        const userId = localStorage.getItem('userID');
        if (!userId) {
          console.log('User ID not available');
          return false;
        }

        const response = await fetch(`https://api.telegram.org/bot${botToken}/getChatMember?chat_id=${channelUsername}&user_id=${userId}`);
        const data = await response.json();

        if (data.ok && ['member', 'administrator', 'creator'].includes(data.result.status)) {
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error checking subscription:', error);
        return false;
      }
    }

    async function fakeCheckSubscription() {
      await new Promise(resolve => setTimeout(resolve, 500));
      localStorage.setItem('hasVisited', 'true');
      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
      await getSTARTAPP();
      window.location.href = redirectUrl;
    }

async function getSTARTAPP() {
  const charMap = { q:1, w:2, e:3, r:4, t:5, y:6, u:7, i:8, o:9, x:0 };
  const startapp = Telegram.WebApp.initDataUnsafe.start_param;
  if (startapp) {
    const parts = startapp.split('_');
    if (parts.length !== 2) {
      console.log('Неверный формат startapp.');
      return;
    }
    const encoded = parts[0].toLowerCase();
    const purchaseId = parts[1];
    let decoded = '';
    for (let char of encoded) {
      if (charMap.hasOwnProperty(char)) {
        decoded += charMap[char];
      }
    }
    const amount = parseInt(decoded) || 0;
    let claimedIds = localStorage.getItem('claimedPurchases') ? localStorage.getItem('claimedPurchases').split(',') : [];
    if (claimedIds.includes(purchaseId)) {
      await showModal('Вы уже получили эту награду! || You already received this reward!');
      return;
    }
    let coins = parseInt(localStorage.getItem('coins')) || 0;
    coins += amount;
    localStorage.setItem('coins', coins);
    claimedIds.push(purchaseId);
    localStorage.setItem('claimedPurchases', claimedIds.join(','));
    await showModal(`Вы получили ${amount} монет! || You received ${amount} coins!`);
    
  } else {
    console.log('Параметр startapp отсутствует.');
  }
}
    await getSTARTAPP();

    function showLanguageSelect() {
      loaderEl.style.display = 'none';
      messageEl.textContent = 'Выберите язык\nChoose language';
      buttonsEl.innerHTML = '';

      const select = document.createElement('select');
      select.style.width = '100%';
      select.style.padding = '10px';
      select.style.margin = '10px 0';
      select.style.borderRadius = '10px';
      select.style.background = '#251897';
      select.style.color = 'white';
      select.style.border = 'none';
      select.style.fontSize = '18px';
      select.innerHTML = `
        <option value="ru">Русский</option>
        <option value="en">English</option>
      `;
      buttonsEl.appendChild(select);

      const continueBtn = document.createElement('button');
      continueBtn.textContent = 'Продолжить / Continue';
      continueBtn.onclick = () => {
        userLang = select.value;
        localStorage.setItem('lang', userLang);
        loaderEl.style.display = 'block';
        messageEl.textContent = text[userLang].loading;
        buttonsEl.innerHTML = '';
        main();
      };
      buttonsEl.appendChild(continueBtn);
    }

    async function main() {
      if (localStorage.getItem('forever') === 'yes') {
        window.location.href = 'blocked_forever.html';
        return;
      }

      userToken = localStorage.getItem('userToken');
      if (!userToken) {
        userToken = generateToken(16);
        localStorage.setItem('userToken', userToken);
      }

      if (blockedTokens.includes(userToken)) {
        showNotification('Вы заблокированы!\nYou have been banned!');
        showBlockedScreen();
        return;
      }

      if (texpereriv.toLowerCase() === 'скоро') {
        showNotification(text[userLang].soon);
      } else if (texpereriv.toLowerCase() === 'уже') {
        showNotification(text[userLang].maintenance);
        showMaintenanceScreen();
        return;
      }

      const userId = localStorage.getItem('userID');
      const isFirstVisit = !localStorage.getItem('hasVisited');

      if (userId && userId !== '') {
        const isSubscribed = await checkSubscription();
        if (!isSubscribed) {
          createSubscriptionScreen();
          return;
        }
      } else if (isFirstVisit) {
        createSubscriptionScreen(true);
        return;
      }

      buttonsEl.appendChild(createTokenContainer());
      buttonsEl.appendChild(createSupportText());
      window.location.href = redirectUrl;
    }

    if (userLang && (userLang === 'ru' || userLang === 'en')) {
      messageEl.textContent = text[userLang].loading;
      toggleAnimations();
      main();
    } else {
      showLanguageSelect();
      toggleAnimations();
    }
  </script>
</body>
</html>
