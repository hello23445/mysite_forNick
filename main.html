<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Main</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsqr.min.js"></script>
    <style>
        :root {
            --bg: #060039;
            --bg-soft: #0b0660;
            --card: #0d0870;
            --text: #d9d9d9;
            --muted: #a7a7c7;
            --accent: #5f57ff;
            --accent-2: #8f87ff;
            --btn: #251897;
            --shadow: rgba(0,0,0,.35);
            --disabled: #4a4a4a;
            --snow-frost: rgba(255, 255, 255, 0.12);
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: relative;
        }
        #bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        /* === –°–ù–ï–ñ–ù–´–ô –°–õ–û–ô –ù–ê–î –í–°–ï–ú, –ù–û –ü–û–î –ö–ù–û–ü–ö–ê–ú–ò === */
        #snowCanvas, #snowPile {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        #snowPile {
            bottom: 0;
            top: auto;
            height: 0;
            background: linear-gradient(to top, rgba(255,255,255,0.9), rgba(255,255,255,0.3), transparent);
            transition: height 1s ease-out;
            z-index: 6;
        }
        /* === TOP BAR –ü–û–í–ï–†–• –°–ù–ï–ì–ê === */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: linear-gradient(180deg, rgba(0,0,0,.35), transparent);
            backdrop-filter: blur(6px);
        }
        #mainTopBar { justify-content: flex-end; }
        #settingsTopBar { justify-content: space-between; gap: 6px; }
        #settingsTopBar .title { flex: 1; text-align: center; font-weight: 700; font-size: 16px; letter-spacing: .2px; }
        #sideTopBar { justify-content: space-between; gap: 6px; }
        #sideTopBar .title { flex: 1; text-align: center; font-weight: 700; font-size: 16px; letter-spacing: .2px; }
        /* === –°–ù–ï–ñ–ù–´–ô –°–¢–ò–õ–¨ –ö–ù–û–ü–û–ö === */
        .icon-btn, .btn {
            position: relative;
            overflow: hidden;
            transition: all .15s ease;
        }
        .icon-btn::before, .btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--snow-frost);
            opacity: 0;
            border-radius: inherit;
            pointer-events: none;
            transition: opacity .3s ease;
        }
        .icon-btn:hover::before, .btn:hover::before {
            opacity: 0.3;
        }
        .icon-btn::after, .btn::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 10%, transparent 40%);
            opacity: 0;
            transform: translateX(-100%) translateY(-100%) rotate(30deg);
            transition: opacity .4s ease;
        }
        .icon-btn:hover::after, .btn:hover::after {
            opacity: 1;
            transform: translateX(100%) translateY(100%) rotate(30deg);
            transition: transform 0.6s ease, opacity 0.2s ease;
        }
        .icon-btn {
            display: inline-flex; align-items: center; justify-content: center;
            background: #090975; border: 1px solid rgba(255,255,255,.08);
            color: var(--text); font-size: 16px; width: 36px; height: 36px; border-radius: 10px;
            cursor: pointer; box-shadow: 0 4px 12px var(--shadow);
        }
        .icon-btn:hover { transform: translateY(-1px); background: #0b0bb0; }
        .main { text-align: center; margin: 16px auto 0; padding: 0 12px; max-width: 860px; }
        h2 { margin: 8px 0 6px; font-weight: 800; font-size: 18px; }
        .buttons-container {
            display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin-top: 12px; justify-items: stretch; }
        .settings-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-top: 12px; }
        .btn {
            --pad: 10px;
            padding: var(--pad);
            background: linear-gradient(180deg, var(--btn), #1b1280);
            color: var(--text); border: 1px solid rgba(255,255,255,.08); border-radius: 12px; cursor: pointer; width: 100%; font-size: 13px; font-weight: 600;
            box-shadow: 0 4px 12px var(--shadow);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 16px var(--shadow); }
        .btn:disabled {
            opacity: .6;
            cursor: not-allowed;
            background: var(--disabled);
        }
        .btn .left-icon { margin-right: 6px; }
        .btn .right-icon { margin-left: 6px; }
        #maintenance { display: none; text-align: center; margin-top: 16px; color: #ff6b6b; padding: 10px; }
        .card {
            background: linear-gradient(180deg, var(--card), #0b0862);
            border: 1px solid rgba(255,255,255,.08);
            border-radius: 14px; padding: 12px; box-shadow: 0 12px 32px var(--shadow); }
        .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .card h3 { margin: 6px 4px 8px; font-size: 14px; color: var(--muted); font-weight: 700; letter-spacing: .2px; }
        .field { display: flex; align-items: center; gap: 8px; flex-direction: column; }
        .lang-field { display: flex; align-items: center; gap: 8px; width: 100%; }
        select#langSelect { flex: 1; min-width: 140px; padding: 10px; background: var(--bg-soft); color: var(--text); border-radius: 10px; border: 1px solid rgba(255,255,255,.08); }
        #tok { margin-top: 6px; background: var(--bg); border: 1px dashed rgba(255,255,255,.15); width: 100%; }
        #statSelect, #avatarVisibilitySelect, #theme {
            flex: 1; min-width: 140px; padding: 10px; background: var(--bg-soft); color: var(--text); border-radius: 10px; border: 1px solid rgba(255,255,255,.08); }
        @media (max-width: 560px) {
            .buttons-container { grid-template-columns: 1fr; }
            .field { align-items: stretch; }
            .lang-field { flex-direction: column; align-items: flex-start; }
            #langSelect, #avatarVisibilitySelect { width: 100%; min-width: 100%; padding: 12px; font-size: 16px; min-height: 44px; }
            #tok { width: 100%; }
            .label { font-size: 16px; }
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-content {
            padding: 8px 0;
            font-size: 13px;
            line-height: 1.4;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 40;
        }
        #sideMenu {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: var(--bg);
            z-index: 50;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.5s ease-in-out;
        }
        #sideMenu.open { transform: translateX(0); }
        @media (max-width: 400px) { #sideMenu { width: 100%; } }
        .side-buttons { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .coins {
            background: linear-gradient(145deg, #060039, #0a004d);
            border-radius: 12px;
            padding: 10px 10px;
            margin-right: 1%;
            color: #e0e0ff;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 0 10px rgba(96, 75, 254, 0.3), inset 0 0 8px rgba(30, 20, 100, 0.5);
        }
        .coins i { font-style: normal; font-weight: normal; color: inherit; pointer-events: none; }
        .label { font-size: 14px; font-weight: 600; color: var(--muted); }
        /* === –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö: –ü–†–û–ö–†–£–¢–ö–ê + –°–ö–í–û–ó–ù–û–ô –§–û–ù –ò –°–ù–ï–ì === */
        #settingsMenu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 30;
            overflow: hidden;
        }
        .settings-wrap {
            max-width: 860px;
            margin: 0 auto;
            padding: 8px 12px 80px;
            height: calc(100vh - 56px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            pointer-events: auto;
            background: transparent !important;
        }
        .settings-wrap * { pointer-events: auto; }
        .settings-wrap::-webkit-scrollbar {
            width: 6px;
        }
        .settings-wrap::-webkit-scrollbar-track { background: transparent; }
        .settings-wrap::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        .settings-wrap::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        #settingsMenu .card {
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(180deg, rgba(13, 8, 112, 0.92), rgba(11, 8, 98, 0.92));
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, .08);
        }
        #settingsMenu .card-header h3 {
            margin: 4px 0;
            font-size: 13.5px;
        }
        #settingsMenu .collapsible-content {
            padding: 6px 0;
            font-size: 12.5px;
        }
        #settingsMenu .btn {
            padding: 9px;
            font-size: 12.8px;
        }
        #settingsMenu select {
            padding: 9px;
            font-size: 13px;
        }
        @media (max-width: 560px) {
            .settings-wrap {
                padding: 6px 10px 70px;
                height: calc(100vh - 52px);
            }
            #settingsMenu .card { padding: 8px; }
            #settingsMenu .btn, #settingsMenu select {
                font-size: 15px;
                padding: 11px;
                min-height: 42px;
            }
        }
        .no-animations * {
            transition: none !important;
            animation: none !important;
        }
        /*–ù–∞—á–∞–ª–æ –∫–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞*/
        @import url("https://fonts.googleapis.com/css2?family=Roboto&display=swap");
        body, html {
          margin: 0;
          padding: 0;
          width: 100%;
          height: 100%;
          overflow: hidden;
          background: #001;
        }
        canvas {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 0;
        }
        #controls {
          position: fixed;
          top: 10px;
          left: 10px;
          z-index: 100;
          display: flex;
          align-items: center;
          z-index: 1;
        }
        button {
          background-color: #4CAF50;
          border: none;
          color: white;
          padding: 15px 32px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          border-radius: 10px;
          font-size: 16px;
          margin: 4px 2px;
          cursor: pointer;
          transition: background-color 0.3s;
          &:hover {
            background-color: #25902950;
          }
          &:active {
            background-color: #00FFFFCC;
          }
        }
        .container {
          margin: 0 auto;
          padding: 2rem;
          position: absolute;
          width: 100%;
          font-family: "Roboto", sans-serif;
          text-shadow: 0 0 5px #000, 0 0 10px #000;
          color: #fff;
          filter: drop-shadow(0 0 10px rgba(0, 0, 50, 0.7))
        drop-shadow(0 0 15px rgba(0, 0, 0, 0.5))
        drop-shadow(0 0 20px rgba(0, 0, 0, 0.3));
          z-index: 2;
        }
        /* Phone User */
        @media (max-width: 768px) {
          .container {
            font-size: 0.1rem;
          }
        }
        /*–ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞*/
    </style>
</head>
<body>
    <div id="bg"></div>
    //–ù–∞—á–∞–ª–æ –∫–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞
    <canvas id="glCanvas"></canvas>
    <div class="container">
    </div>
    //–ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞
    <!-- //–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —Å–Ω–µ–≥: –Ω–∞—á–∞–ª–æ -->
    <canvas id="snowCanvas"></canvas>
    <div id="snowPile"></div>
    <!-- //–Ω–æ–≤–æ–≥–æ–¥–Ω–∏–π —Å–Ω–µ–≥: –∫–æ–Ω–µ—Ü -->
    <div id="maintenance">
        <h2 data-translate="maintenance" id="maintenanceM"></h2>
    </div>
    <div class="top-bar" id="mainTopBar">
        <h4 class="coins" id="coins">0</h4>
        <button class="icon-btn" id="sideMenuBtn" title="Menu"><i class="fa-solid fa-bars"></i></button>
    </div>
    <div class="main" id="mainMenu">
        <h2 data-translate="main" id="mainM"></h2>
        <div class="buttons-container" id="featureButtons"></div>
    </div>
    <!-- –ù–ê–°–¢–†–û–ô–ö–ò: –°–ö–í–û–ó–ù–û–ô –§–û–ù + –°–ù–ï–ì + –ü–†–û–ö–†–£–¢–ö–ê -->
    <div id="settingsMenu">
        <div class="top-bar" id="settingsTopBar">
            <button class="icon-btn" id="backBtn" title="Back"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="title" data-translate="settingsTitle" id="settingsTitle"></span>
            <span style="width:36px; height:36px;"></span>
        </div>
        <div class="settings-wrap">
            <div class="row">
                <div class="card">
                    <div class="card-header">
                        <h3 data-translate="langSectionTitle">–Ø–∑—ã–∫ / Language</h3>
                        <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-up"></i></button>
                    </div>
                    <div class="collapsible-content" style="display: block;">
                        <div class="field">
                            <div class="lang-field">
                                <i class="fa-solid fa-globe" style="font-size: 18px;"></i>
                                <select id="langSelect"></select>
                            </div>
                            <div class="card" style="width: 100%;">
                                <div class="card-header">
                                    <h3 id="showmytokentext">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                                    <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                                </div>
                                <div style="display: none; margin-top: 1%;">
                                    <button class="btn" id="tok"><i class="fa-solid fa-key left-icon"></i><span>Token</span></button>
                                    <p style="margin-top: 0%; margin-bottom: 0%; color: rgb(210, 209, 209);" id="userTokenWarning"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 data-translate="statSectionTitle" id="stat_setting_text"></h3>
                        <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                    </div>
                    <div class="collapsible-content" style="display: none;" id="stat_setting">
                        <select id="statSelect" onchange="localStorage.setItem('statistic_turn', this.value === 'yes' ? 'yes' : 'no')">
                            <option value="yes">–°–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</option>
                            <option value="no">–ù–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</option>
                        </select>
                        <button class="btn" id="clear" onclick="clearAllStatistic()" style="margin-top: 2%;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 data-translate="accountSectionTitle" id="account-settings"></h3>
                        <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                    </div>
                    <div style="display: none;">
                        <div class="card" style="display: none; margin-top: 1%;" id="my_idBox">
                            <div class="card-header">
                                <h3 id="my_idHeader">–ú–æ–π Telegram ID</h3>
                                <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                            </div>
                            <div style="display: none; margin-top: 1%;">
                                <button id="myID" class="btn">–í–∞—à Telegram ID</button>
                            </div>
                        </div>
                        <button class="btn" id="userID-confirming" onclick="window.location.href = 'set_telegram_id.html'">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π Telegram ID</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 data-translate="backgroundSectionTitle"></h3>
                        <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                    </div>
                    <div style="display: none;">
                        <div class="card" style="margin-bottom: 8px; margin-top: 2%;">
                            <div class="card-header">
                                <h3 data-translate="backgroundSubTitle"></h3>
                                <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                            </div>
                            <div style="display: none; margin-top: 1%;">
                                <select id="theme"></select>
                                <div id="customUpload" style="display:none; margin-top:8px;">
                                    <button class="btn" id="uploadCustom" data-translate="uploadCustomBg"></button>
                                </div>
                                <div style="margin-top:8px; display:flex; align-items:center; gap:8px;" id="blurBackground_settingShow">
                                    <label class="label" data-translate="blurBackground" for="blurToggle"></label>
                                    <input type="checkbox" id="blurToggle" />
                                </div>
                                <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                                    <label class="label" data-translate="snow" for="snowToggle"></label>
                                    <input type="checkbox" id="snowToggle" />
                                </div>
                            </div>
                        </div>
                        <div class="card" style="margin-top: 3%;">
                            <div class="card-header">
                                <h3 data-translate="animationsSubTitle"></h3>
                                <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                            </div>
                            <div style="display: none; margin-top: 2%;">
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <label class="label" data-translate="animations" for="animationsToggle"></label>
                                    <input type="checkbox" id="animationsToggle" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 data-translate="supportSectionTitle">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3>
                        <button class="icon-btn toggle-btn"><i class="fa-solid fa-caret-down"></i></button>
                    </div>
                    <div class="collapsible-content" style="display: none;">
                        <div class="settings-buttons" id="settingsButtons"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="overlay"></div>
    <div id="sideMenu">
        <div class="top-bar" id="sideTopBar">
            <button class="icon-btn" id="sideCloseBtn" title="Close"><i class="fa-solid fa-arrow-left"></i></button>
            <span class="title" data-translate="menuTitle"></span>
            <span style="width:36px; height:36px;"></span>
        </div>
        <div class="side-wrap" style="padding:16px 12px;">
            <div class="side-buttons" id="sideButtons"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <script>
      
        if (!localStorage.getItem('userName')) {
            localStorage.setItem('userName', 'User');
        }
        const gasUrl = 'https://script.google.com/macros/s/AKfycbxkvAXAMckjNcVYGh3BmSmMI608TbUAwrmohywdKoVCMbmCz69Y0dKb3r9OP89NlH8s/exec';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxbr9H0F70BHo2js1tKD_P1MVChn-9NKr8av1p0ZtJj6h9845b3dB2xDarr_B1zpFwR/exec';
        const LINKS = {
            complaintRU: "https://t.me/NickNaymesBot/submit_complaints",
            supportRU: "https://t.me/Clickerstart_bot",
            supportEN: "https://t.me/Clickerstart_bot"
        };
        const filesRu = {
            indexed_money: 'indexed_money.html',
            shop: 'shop_ru.html',
            nickname: 'nickname.html',
            description: 'description.html',
            profile: 'avatar.html',
            lego: 'lego.html',
            font: 'font.html',
            sites: 'https://sites.google.com/',
            ascii: 'ascii.html',
            qr: 'qr.html',
            music: 'music.html',
            colors: 'colors.html',
            ai: 'ai.html',
            support: 'support.html',
            connection: 'connection.html',
            popular: 'popular(ru).html',
            myshop: 'myshop_ru.html',
            tasks: 'tasks.html',
            ai_video: 'https://t.me/GeneratorVideos1Bot'
        };
        const filesEn = {
            indexed_money: 'indexed_money_en.html',
            tasks: 'tasks_en.html',
            shop: 'shop_en.html',
            nickname: 'nickname_en.html',
            description: 'description_en.html',
            profile: 'avatar_en.html',
            lego: 'lego_en.html',
            font: 'font_en.html',
            sites: 'https://sites.google.com/',
            ascii: 'ascii_en.html',
            qr: 'qr_en.html',
            music: 'music_en.html',
            colors: 'colors_en.html',
            ai: 'ai_en.html',
            support: 'support_en.html',
            connection: 'connection_en.html',
            popular: 'popular(en).html',
            myshop: 'myshop_ru.html',
            ai_video: 'https://t.me/GeneratorVideos1Bot'
        };
        let storedCoins = parseInt(localStorage.getItem('coins'));
        if (!localStorage.getItem('coins') || storedCoins < 0) {
            localStorage.setItem('coins', '0');
        } else {
            document.getElementById('coins').innerHTML = '<i style="user-select: none;">ü™ô</i>' + formatNumber(localStorage.getItem('coins'));
        }
        const tok = document.getElementById("tok");
        tok.style.background = "linear-gradient(180deg, var(--btn), #1b1280)";
        tok.style.color = "#fff";
        tok.style.border = "none";
        tok.style.borderRadius = "12px";
        tok.style.padding = "10px 16px";
        tok.style.fontWeight = "600";
        tok.style.cursor = "pointer";
        let lang = localStorage.getItem('lang') || 'ru';
        if (!localStorage.getItem('statistic_turn')) {
            localStorage.setItem('statistic_turn', 'yes');
        }
        let customBackgrounds = JSON.parse(localStorage.getItem('customBackgrounds')) || [];
        let translations = {
            ru: {
                fixing: '–†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –≤ —ç—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏',
                money: '–ò–≥—Ä–∞—Ç—å –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–æ–Ω–µ—Ç—ã',
                task: '–ó–∞–¥–∞–Ω–∏—è –∏ –Ω–∞–≥—Ä–∞–¥—ã',
                shop: "–ú–∞–≥–∞–∑–∏–Ω",
                premium: '–ü—Ä–µ–º–∏—É–º',
                main: "–ß—Ç–æ –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å?",
                maintenance: "–ü—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ.",
                settingsTitle: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                statsTitle: "–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è",
                langSectionTitle: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞ –∏ —Ç–æ–∫–µ–Ω–∞",
                supportSectionTitle: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Å–≤—è–∑—å",
                userDataSectionTitle: "–ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö",
                privacySectionTitle: "–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å",
                privacyLabel: "–ö—Ç–æ –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –º–æ—é –∞–≤–∞—Ç–∞—Ä–∫—É:",
                featureButtons: [
                    "–ù–∏–∫–Ω–µ–π–º","–û–ø–∏—Å–∞–Ω–∏–µ","–ê–≤–∞—Ç–∞—Ä–∫–∞","–õe–≥o","–®—Ä–∏—Ñ—Ç","–°–∞–π—Ç",
                    "–°–∏–º–≤–æ–ª-–∞—Ä—Ç","QR-–∫–æ–¥","–ú—É–∑—ã–∫–∞","–¶–≤–µ—Ç–∞","–ò–ò-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–æ—Ç–æ", "–ò–ò-–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–µ–æ"
                ],
                settingsButtons: ["–ü–æ–¥–¥–µ—Ä–∂–∫–∞","–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"],
                langOptions: ["–†—É—Å—Å–∫–∏–π","English"],
                writeComplaint: "–ù–∞–ø–∏—Å–∞—Ç—å –∂–∞–ª–æ–±—É",
                writeSupport: "–ù–∞–ø–∏—Å–∞—Ç—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
                historySectionTitle: "–ò—Å—Ç–æ—Ä–∏—è",
                tokenSectionTitle: "–¢–æ–∫–µ–Ω",
                usageTimeTitle: "–í—Ä–µ–º—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
                menuTitle: "–ú–µ–Ω—é",
                home: "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                profile: "–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å",
                popular: "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ",
                settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                wishlist: "–ú–æ–π —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ",
                myshop: "–ú–æ–π –º–∞–≥–∞–∑–∏–Ω",
                statSectionTitle: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                statCollectYes: "–°–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                statCollectNo: "–ù–µ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                statClear: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                accountSectionTitle: "–ê–∫–∫–∞—É–Ω—Ç",
                userIDButton: "–ü—Ä–∏–≤—è–∑–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π Telegram ID",
                backgroundSectionTitle: "–í–∏–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
                uploadCustomBg: "–í—ã–±—Ä–∞—Ç—å —Ñ–æ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏",
                blurBackground: "–†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞",
                animations: "–ê–Ω–∏–º–∞—Ü–∏–∏",
                snow: "–£–∫—Ä–∞—Å–∏—Ç—å —Å–Ω–µ–≥",
                backgroundSubTitle: "–§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
                animationsSubTitle: "–ê–Ω–∏–º–∞—Ü–∏–∏"
            },
            en: {
                fixing: 'Error Detection and Correction Mode in this App',
                money: 'Play and earn coins',
                task: 'Tasks and Rewards',
                shop: "Shop",
                premium: 'Premium',
                main: "What do you want to create?",
                maintenance: "Maintenance in progress.",
                settingsTitle: "Settings",
                statsTitle: "Your all-time statistics",
                langSectionTitle: "Language & token",
                supportSectionTitle: "Support",
                userDataSectionTitle: "Save and load datas",
                privacySectionTitle: "Privacy",
                privacyLabel: "Who can see my avatar:",
                featureButtons: [
                    "Nickname","Description","Profile","Lego","Font","Sites",
                    "ASCII-art","QR-code","Music","Colors","AI-Photo Generator", "AI-Video Generator"
                ],
                settingsButtons: ["Support","Connection check"],
                langOptions: ["–†—É—Å—Å–∫–∏–π","English"],
                writeComplaint: "",
                writeSupport: "Contact Support",
                historySectionTitle: "History",
                tokenSectionTitle: "Token",
                usageTimeTitle: "Usage Time",
                menuTitle: "Menu",
                home: "Return to main menu",
                stats: "Statistics",
                profile: "My profile",
                popular: "Popular",
                settings: "Settings",
                wishlist: "My wishlist",
                myshop: "My Shop",
                statSectionTitle: "Statistics settings",
                statCollectYes: "Collect data for statistics",
                statCollectNo: "Do not collect data for statistics",
                statClear: "Clear all statistics data",
                accountSectionTitle: "Account",
                userIDButton: "Link or change my Telegram ID",
                backgroundSectionTitle: "App appearance",
                uploadCustomBg: "Select background to upload",
                blurBackground: "Background blur",
                animations: "Animations",
                snow: "Decorate snow",
                backgroundSubTitle: "App Background",
                animationsSubTitle: "Animations"
            }
        };
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
        function createButton({ text, icon, onClick, href, newTab=false, disabled=false, id, duplicateIcon=false }) {
            const btn = document.createElement('button');
            btn.className = 'btn';
            if (id) btn.id = id;
            if (icon) {
                const i = document.createElement('i');
                i.className = icon;
                i.classList.add('left-icon');
                btn.appendChild(i);
            }
            const span = document.createElement('span');
            span.textContent = text;
            btn.appendChild(span);
            if (duplicateIcon && icon) {
                const i2 = document.createElement('i');
                i2.className = icon;
                i2.classList.add('right-icon');
                btn.appendChild(i2);
            }
            if (href) {
                btn.onclick = () => {
                    incrementCoins();
                    newTab ? window.open(href, '_blank') : window.location.href = href;
                };
            } else if (onClick) {
                btn.onclick = onClick;
            }
            if (disabled) {
                btn.disabled = true;
                btn.style.background = 'var(--disabled)';
                btn.title = lang === 'ru' ? '–£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –≤ –æ–±—ä–µ–∫—Ç–µ LINKS' : 'Specify a link in the LINKS object';
            }
            return btn;
        }
        function applyTranslations() {
            checkUserID();
            document.getElementById('showmytokentext').style.color = 'white';
            if (lang === 'ru') {
                document.getElementById('userTokenWarning').textContent = '–¢–æ–∫–µ–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ–π —Ç–æ–∫–µ–Ω –¥—Ä—É–≥–∏–º.';
                document.getElementById('showmytokentext').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π —Ç–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
            } else {
                document.getElementById('userTokenWarning').textContent = 'The token is required to work with the support service and to load your data in this application. Be careful before sharing your token with others.';
                document.getElementById('showmytokentext').textContent = 'Show my user token';
            }
            const files = lang === 'ru' ? filesRu : filesEn;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[lang][key] !== undefined) {
                    el.textContent = translations[lang][key];
                }
            });
            const featureContainer = document.getElementById('featureButtons');
            featureContainer.innerHTML = '';
            const featureKeys = ['nickname','description','profile','lego','font','sites','ascii','qr','music','colors','ai', 'ai_video'];
            translations[lang].featureButtons.forEach((text, i) => {
                const url = files[featureKeys[i]];
                const isExternal = /^https?:\/\//i.test(url);
                const btn = createButton({ text, icon: 'fa-solid fa-shapes', href: url, newTab: isExternal });
                featureContainer.appendChild(btn);
            });
            const settingsContainer = document.getElementById('settingsButtons');
            settingsContainer.innerHTML = '';
            const settingsKeys = ['support','connection'];
            const settingsIcons = ['fa-solid fa-circle-info','fa-solid fa-wifi'];
            translations[lang].settingsButtons.forEach((text, i) => {
                const url = files[settingsKeys[i]];
                const btn = createButton({ text, icon: settingsIcons[i], href: url });
                settingsContainer.appendChild(btn);
            });
            document.getElementById('account-settings').textContent = translations[lang].accountSectionTitle;
            document.getElementById('userID-confirming').textContent = translations[lang].userIDButton;
            document.getElementById('stat_setting_text').textContent = translations[lang].statSectionTitle;
            document.getElementById('stat_setting').innerHTML = `
                <select id="statSelect" onchange="localStorage.setItem('statistic_turn', this.value === 'yes' ? 'yes' : 'no')">
                    <option value="yes">${translations[lang].statCollectYes}</option>
                    <option value="no">${translations[lang].statCollectNo}</option>
                </select>
                <button class="btn" id="clear" onclick="clearAllStatistic()" style="margin-top: 2%;">${translations[lang].statClear}</button>
            `;
            const statSelect = document.getElementById('statSelect');
            statSelect.value = localStorage.getItem('statistic_turn') || 'yes';
            if (lang === 'ru') {
                const hasLink = !!LINKS.complaintRU && /^https?:\/\//i.test(LINKS.complaintRU);
                const complaintBtn = createButton({
                    text: translations.ru.writeComplaint,
                    icon: 'fa-solid fa-pen-to-square',
                    href: hasLink ? LINKS.complaintRU : undefined,
                    newTab: true,
                    disabled: !hasLink
                });
                settingsContainer.appendChild(complaintBtn);
            }
            const supportLink = lang === 'ru' ? LINKS.supportRU : LINKS.supportEN;
            const supportOk = !!supportLink && /^https?:\/\//i.test(supportLink);
            const writeSupportBtn = createButton({
                text: translations[lang].writeSupport,
                icon: 'fa-solid fa-headset',
                href: supportOk ? supportLink : undefined,
                newTab: true,
                disabled: !supportOk
            });
            settingsContainer.appendChild(writeSupportBtn);
            const langSelect = document.getElementById('langSelect');
            langSelect.innerHTML = '';
            translations[lang].langOptions.forEach((text, i) => {
                const option = document.createElement('option');
                option.value = i === 0 ? 'ru' : 'en';
                option.textContent = text;
                option.selected = (option.value === lang);
                langSelect.appendChild(option);
            });
            // Theme select
            const themeSelect = document.getElementById('theme');
            themeSelect.innerHTML = '';
            const themeOptionsFixed = lang === 'ru'
                ? ["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ–Ω", "–§–æ–Ω —Å–æ–±—ã—Ç–∏—è(–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π)", "–¢–µ–º–Ω—ã–π"]
                : ["Default background", "Event background (New Year)", "Dark"];
            for (let i = 0; i < 3; i++) {
                const option = document.createElement('option');
                option.value = `theme${i + 1}`;
                option.textContent = themeOptionsFixed[i];
                themeSelect.appendChild(option);
            }
            customBackgrounds.forEach((bg, i) => {
                const option = document.createElement('option');
                option.value = `custom_${i}`;
                option.textContent = bg.name;
                themeSelect.appendChild(option);
            });
            const uploadOption = document.createElement('option');
            uploadOption.value = 'upload';
            uploadOption.textContent = lang === 'ru' ? "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω" : "Upload your own background";
            themeSelect.appendChild(uploadOption);
            let storedTheme = localStorage.getItem('theme') || 'theme1';
            if (storedTheme === 'upload' || !Array.from(themeSelect.options).some(opt => opt.value === storedTheme)) {
                storedTheme = 'theme1';
                localStorage.setItem('theme', 'theme1');
            }
            themeSelect.value = storedTheme;
        }
        function initTokenButton(btnId) {
            let isVisible = false;
            const updateLabel = () => {
                const userToken = localStorage.getItem('userToken') || '';
                const maskedToken = userToken ? '*'.repeat(userToken.length) : '';
                const btn = document.getElementById(btnId);
                if (isVisible) {
                    btn.innerHTML = '<i class="fa-solid fa-key left-icon"></i><span>' +
                        (lang === 'ru' ? '–í–∞—à —Ç–æ–∫–µ–Ω: ' + userToken + ' (–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)' :
                        'Your token: ' + userToken + ' (Click to copy)') + '</span>';
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-key left-icon"></i><span>' +
                        (lang === 'ru' ? '–í–∞—à —Ç–æ–∫–µ–Ω: ' + maskedToken + ' (–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–æ–∫–∞–∑–∞)' :
                        'Your token: ' + maskedToken + ' (Click to show)') + '</span>';
                }
            };
            updateLabel();
            document.getElementById(btnId).onclick = () => {
                const userToken = localStorage.getItem('userToken') || '';
                if (!isVisible) {
                    isVisible = true;
                    updateLabel();
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = userToken;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert(lang === 'ru' ? '–¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!' : 'Token copied!');
                    } catch (err) {
                        alert(lang === 'ru' ? '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω.' : 'Failed to copy token.');
                    }
                    document.body.removeChild(textArea);
                    isVisible = false;
                    updateLabel();
                }
            };
        }
        applyTranslations();
        initTokenButton('tok');
        document.getElementById('backBtn').onclick = () => {
            document.getElementById('settingsMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('mainTopBar').style.display = 'flex';
            saveUserDataToGoogleSheets();
        };
        document.getElementById('langSelect').onchange = function() {
            lang = this.value;
            localStorage.setItem('lang', lang);
            applyTranslations();
            initTokenButton('tok');
        };
        document.getElementById('statSelect').onchange = function() {
            const selectedOption = this.options[this.selectedIndex].text;
            const statTurn = selectedOption === translations[lang].statCollectYes ? 'yes' : 'no';
            localStorage.setItem('statistic_turn', statTurn);
            applySideButtons();
        };
        const m = localStorage.getItem('m');
        if (m === '–£–∂–µ' || m === '—É–∂–µ') {
            document.querySelectorAll('div').forEach(el => el.style.display = 'none');
            alert(lang === 'ru' ? '–ò–¥–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ' : 'Maintenance in progress');
            document.getElementById('maintenance').style.display = 'block';
            document.getElementById('maintenanceM').textContent = translations[lang].maintenance;
        }
        if (!localStorage.getItem('first_use_date')) {
            localStorage.setItem('first_use_date', new Date().toISOString());
        }
        function clearAllStatistic() {
            let confirmed;
            if (lang === 'ru') {
                confirmed = confirm(
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?\n` +
                    `–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å!\n` +
                    `–í—Å—è –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω—É–ª–µ–Ω–∞, –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞–Ω—É—Ç —Ä–∞–≤–Ω—ã –Ω—É–ª—é!\n` +
                    `–û–ö - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—á–∏—Å—Ç–∫—É\n–û—Ç–º–µ–Ω–∞ - –û—Ç–º–µ–Ω–∏—Ç—å –æ—á–∏—Å—Ç–∫—É.`
                );
            } else {
                confirmed = confirm(
                    `Are you sure you want to clear all your statistics?\n` +
                    `This action cannot be undone!\n` +
                    `All your statistics will be completely reset; all values will be set to zero!\n` +
                    `OK - Confirm reset\nCancel - Cancel reset`
                );
            }
            if (!confirmed) return;
            if (confirmed) {
                alert('DONE');
            }
            const keys = [
                'created_nicknames',
                'created_descriptions',
                'created_profiles',
                'created_lego',
                'created_fonts',
                'created_ascii_arts',
                'created_qr_codes',
                'created_musics',
                'copied_color_codes',
                'copied_nicknames',
                'copied_descriptions',
                'shared_nicknames',
                'shared_descriptions',
                'usage_day',
                'usage_week',
                'usage_month',
                'last_day',
                'last_week',
                'last_month',
                'nick_story',
                'desc_story'
            ];
            keys.forEach(key => localStorage.removeItem(key));
            localStorage.setItem('statistic_turn', 'yes');
            applyTranslations();
        }
        const dataKeys = [
            'created_nicknames', 'created_descriptions', 'created_profiles', 'created_lego',
            'created_fonts', 'created_ascii_arts', 'created_qr_codes', 'created_musics',
            'copied_color_codes', 'copied_nicknames', 'copied_descriptions',
            'shared_nicknames', 'shared_descriptions', 'nick_story', 'desc_story',
            'first_use_date', 'statistic_turn', 'lang', 'avatar_visibility', 'loved', 'loved_descs', 'liked_users', 'userName', 'userAvatar'
        ];
        const statKeys = [
            'created_nicknames', 'created_descriptions', 'created_profiles', 'created_lego',
            'created_fonts', 'created_ascii_arts', 'created_qr_codes', 'created_musics',
            'copied_color_codes', 'copied_nicknames', 'copied_descriptions',
            'shared_nicknames', 'shared_descriptions', 'nick_story', 'desc_story'
        ];
        async function uploadAvatarToDrive(base64) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'upload_avatar',
                        base64: base64,
                        token: localStorage.getItem('userToken') || ''
                    }),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    redirect: 'follow'
                });
                const result = await response.json();
                if (result.success && result.fileId) {
                    return `https://drive.google.com/file/d/${result.fileId}/view`;
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (err) {
                console.error('Upload avatar error:', err);
                throw err;
            }
        }
        async function saveUserDataToGoogleSheets() {
            const SPREADSHEET_ID = '145dg5-KwMTiz3dVWTjLzXtHOQ5z9Gufm47LgLKsXHWU';
            try {
                const now = new Date();
                const dateStr = `${now.getDate().toString().padStart(2, '0')}.${(now.getMonth() + 1).toString().padStart(2, '0')}.${now.getFullYear().toString().slice(-2)} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                const userToken = localStorage.getItem('userToken') || '';
                const username = localStorage.getItem('userName') || '';
                let avatarFromStorage = localStorage.getItem('userAvatar');
                let avatar = 'user_profile_photo.png';
                if (avatarFromStorage && avatarFromStorage.trim() !== '') {
                    if (avatarFromStorage.startsWith("http")) {
                        avatar = avatarFromStorage;
                    } else if (avatarFromStorage.startsWith("data:image")) {
                        avatar = avatarFromStorage;
                    } else {
                        avatar = avatarFromStorage;
                    }
                }
                const avatarVisibility = localStorage.getItem('avatar_visibility') || 'all';
                const firstUseDate = localStorage.getItem('first_use_date');
                let usageTime = '';
                if (firstUseDate) {
                    const firstDate = new Date(firstUseDate);
                    const diffMs = now - firstDate;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const diffHrs = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    usageTime = `${diffDays}d ${diffHrs}h ${diffMins}m`;
                }
                const statTurn = localStorage.getItem('statistic_turn') || 'yes';
                const stats = {};
                statKeys.forEach(key => {
                    const raw = localStorage.getItem(key);
                    const n = parseInt(raw, 10);
                    stats[key] = (raw === null || raw === undefined || isNaN(n)) ? '0' : String(n);
                });
                const statsStr = statTurn === 'yes' ? JSON.stringify(stats) : `(–û—Ç–∫–ª—é—á–µ–Ω–æ)${JSON.stringify(stats)}`;
                const likedUsers = localStorage.getItem('liked_users') || '';
                const data = {
                    date: dateStr,
                    token: userToken,
                    username: username,
                    avatar: avatar,
                    avatarVisibility: avatarVisibility,
                    usageTime: usageTime,
                    statistics: statsStr,
                    liked_users: likedUsers
                };
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    redirect: 'follow'
                });
                const responseText = await response.text();
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', response.status, responseText);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤ saveUserDataToGoogleSheets:', err);
            }
        }
        function incrementCoins() {
            if (Math.random() < 0.07) {
                let amount = 1;
                if (Math.random() < 0.3) amount += 200;
                if (Math.random() < 0.05) amount += 100;
                let coins = parseInt(localStorage.getItem('coins') || '0');
                coins += amount;
                localStorage.setItem('coins', coins.toString());
                document.getElementById('coins').innerHTML = '<i style="user-select: none;">ü™ô</i>' + formatNumber(coins);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.card-header, .toggle-btn').forEach(element => {
                element.addEventListener('click', (e) => {
                    if (e.target.closest('.toggle-btn') && e.currentTarget.classList.contains('card-header')) {
                        return;
                    }
                    const header = element.closest('.card-header');
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('.toggle-btn i');
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        icon.classList.remove('fa-caret-down');
                        icon.classList.add('fa-caret-up');
                    } else {
                        content.style.display = 'none';
                        icon.classList.remove('fa-caret-up');
                        icon.classList.add('fa-caret-down');
                    }
                });
            });
            const statSelect = document.getElementById('statSelect');
            statSelect.value = localStorage.getItem('statistic_turn') || 'yes';
        });
        const sideMenu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        const sideButtons = document.getElementById('sideButtons');
        function showSideMenu() {
            applyTranslations();
            applySideButtons();
            sideMenu.style.display = 'block';
            overlay.style.display = 'block';
            setTimeout(() => {
                sideMenu.classList.add('open');
            }, 10);
        }
        function hideSideMenu() {
            sideMenu.classList.remove('open');
            setTimeout(() => {
                sideMenu.style.display = 'none';
                overlay.style.display = 'none';
            }, 500);
        }
        document.getElementById('sideMenuBtn').onclick = showSideMenu;
        document.getElementById('sideCloseBtn').onclick = hideSideMenu;
        overlay.onclick = hideSideMenu;
        function showSettings() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('mainTopBar').style.display = 'none';
            document.getElementById('settingsMenu').style.display = 'block';
            applyTranslations();
        }
        function fixingFunction() {
            window.location.href = 'errors.html';
        }
        function applySideButtons() {
            sideButtons.innerHTML = '';
            const files = lang === 'ru' ? filesRu : filesEn;
            const isStatsDisabled = localStorage.getItem('statistic_turn') === 'no';
            const items = [
                { textKey: 'home', icon: 'fa-solid fa-house', onClick: hideSideMenu },
                { textKey: 'fixing', icon: 'fa-solid fa-hammer', onClick: fixingFunction },
                { textKey: 'stats', icon: 'fa-solid fa-chart-simple', href: 'statistics.html', disabled: isStatsDisabled },
                { textKey: 'profile', icon: 'fa-solid fa-user', href: 'user_profile.html' },
                { textKey: 'popular', icon: 'fa-solid fa-square-poll-vertical', href: files.popular },
                { textKey: 'wishlist', icon: 'fa-solid fa-clipboard-list', href: 'izbr.html' },
                { textKey: 'task', icon: 'fa-solid fa-list-check', href: files.tasks },
                { textKey: 'money', icon: 'fa-solid fa-coins', href: files.indexed_money },
                { textKey: 'myshop', icon: 'fa-solid fa-shop', href: files.myshop },
                { textKey: 'shop', icon: 'fa-solid fa-cart-shopping', href: files.shop },
                { textKey: 'premium', icon: 'fa-solid fa-crown', href: 'premium.screen.html' },
                { textKey: 'settings', icon: 'fa-solid fa-gear', onClick: () => { hideSideMenu(); showSettings(); } }
            ];
            items.forEach(item => {
                const btn = createButton({
                    text: translations[lang][item.textKey],
                    icon: item.icon,
                    onClick: item.onClick,
                    href: item.href,
                    duplicateIcon: true,
                    disabled: item.disabled
                });
                sideButtons.appendChild(btn);
            });
        }
        function checkUserID() {
            if (localStorage.getItem('userID')) {
                document.getElementById('my_idHeader').style.color = 'white';
                if (lang === 'ru') {
                    document.getElementById('my_idHeader').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π Telegram ID';
                    document.getElementById('myID').textContent = localStorage.getItem('userID') + ' (–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)';
                } else {
                    document.getElementById('my_idHeader').textContent = 'Show my Telegram ID';
                    document.getElementById('myID').textContent = localStorage.getItem('userID') + ' (Click to copy)';
                }
                document.getElementById('my_idBox').style.display = 'block';
            } else {
                document.getElementById('my_idBox').style.display = 'none';
            }
        }
        document.getElementById('myID').addEventListener('click', (e) => {
            const textToCopy = localStorage.getItem('userID');
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    const lang = localStorage.getItem('lang');
                    const originalText = e.target.textContent;
                    e.target.textContent = lang === 'ru' ? '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!' : 'Copied!';
                    setTimeout(() => {
                        e.target.textContent = originalText;
                    }, 2500);
                })
                .catch(() => {
                    alert(lang === 'ru' ? '–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è' : 'Copy error');
                });
        });
        async function checkTokenAndRedirect() {
            try {
                const userToken = localStorage.getItem('userToken');
                if (!userToken) {
                    console.error('–¢–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
                    return;
                }
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `userToken=${encodeURIComponent(userToken)}`
                });
                const result = await response.json();
                if (result.success) {
                    window.location.href = result.redirectUrl;
                } else {
                    console.error('–û—à–∏–±–∫–∞:', result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞:', error);
            }
        }
        document.addEventListener("click", function (event) {
            const t = event.target;
            if (
                t.tagName !== "INPUT" &&
                t.tagName !== "TEXTAREA" &&
                t.tagName !== "SELECT" &&
                !t.isContentEditable
            ) {
                if (document.activeElement && document.activeElement.blur) {
                    document.activeElement.blur();
                }
            }
        });
        async function securityChecker() {
            const { blockedTokens } = await import('./security.js');
            if (blockedTokens.includes(localStorage.getItem('userToken'))) {
                window.location.href = 'blocked.html';
            }
        }
        setInterval(() => {
            securityChecker();
        }, 1000);
        securityChecker();
        saveUserDataToGoogleSheets();
        setInterval(() => {
            checkTokenAndRedirect();
        }, 6500);
        // === –ù–û–í–û–ì–û–î–ù–ò–ô –°–ù–ï–ì: –£–õ–£–ß–®–ï–ù–ù–´–ô ===
        (function () {
            const canvas = document.getElementById('snowCanvas');
            const ctx = canvas.getContext('2d');
            const pile = document.getElementById('snowPile');
            let width, height;
            const flakes = [];
            const maxFlakes = 120;
            let pileHeight = 0;
            let lastTime = 0;
            let startTime = null;
            let flakeCount = 0;
            const appearDuration = 5000;
            const startDelay = 2000;
            function resize() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }
            function createFlake() {
                return {
                    x: Math.random() * width,
                    y: -10 - Math.random() * 50,
                    radius: Math.random() * 2 + 1,
                    speed: Math.random() * 0.8 + 0.4,
                    opacity: Math.random() * 0.4 + 0.6,
                    sway: Math.random() * 0.15 + 0.05
                };
            }
            function updateFlakes(delta) {
                const now = performance.now();
                if (!startTime) startTime = now;
                const elapsed = now - startTime;
                if (elapsed < startDelay) return;
                const progress = Math.min(1, (elapsed - startDelay) / appearDuration);
                const targetFlakes = Math.floor(progress * maxFlakes);
                while (flakeCount < targetFlakes) {
                    flakes.push(createFlake());
                    flakeCount++;
                }
                flakes.forEach((flake, i) => {
                    flake.y += flake.speed * delta * 60;
                    flake.x += Math.sin(flake.y * 0.005) * flake.sway * delta * 60;
                    if (flake.y > height - pileHeight - 10) {
                        flakes[i] = createFlake();
                        if (Math.random() < 0.01) {
                            pileHeight = Math.min(pileHeight + 0.02, height * 0.3);
                            pile.style.height = pileHeight + 'px';
                        }
                    }
                    if (flake.x > width) flake.x = 0;
                    if (flake.x < 0) flake.x = width;
                });
            }
            function drawFlakes() {
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#fff';
                flakes.forEach(flake => {
                    ctx.globalAlpha = flake.opacity;
                    ctx.beginPath();
                    ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
            function animate(time) {
                if (!lastTime) lastTime = time;
                const delta = (time - lastTime) / 1000;
                lastTime = time;
                updateFlakes(delta);
                drawFlakes();
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize', () => {
                resize();
            });
            resize();
            requestAnimationFrame(animate);
        })();
        // === –ö–û–ù–ï–¶ –°–ù–ï–ì–ê ===
        // Theme handling
        function setTheme(value) {
            const bgDiv = document.getElementById('bg');
            bgDiv.style.backgroundRepeat = 'no-repeat';
            bgDiv.style.backgroundSize = 'cover';
            bgDiv.style.backgroundPosition = 'center center';
            bgDiv.style.backgroundAttachment = 'fixed';
            if (value === 'theme1') {
                bgDiv.style.backgroundImage = 'none';
                bgDiv.style.backgroundColor = 'rgb(0, 0, 79)';
            } else if (value === 'theme2') {
                bgDiv.style.backgroundImage = "url('image.jpg')";
                bgDiv.style.backgroundColor = '';
            } else if (value === 'theme3') {
                bgDiv.style.backgroundImage = 'none';
                bgDiv.style.backgroundColor = 'black';
            } else if (value.startsWith('custom_')) {
                const index = parseInt(value.split('_')[1]);
                const bg = customBackgrounds[index];
                if (bg) {
                    bgDiv.style.backgroundImage = `url(${bg.data})`;
                    bgDiv.style.backgroundColor = '';
                }
            }
            updateBlurDisabled();
            applyBlur();
        }
        function updateBlurDisabled() {
            const themeValue = document.getElementById('theme').value;
            const blurToggle = document.getElementById('blurToggle');
            if (themeValue === 'theme1' || themeValue === 'theme3') {
                blurToggle.disabled = true;
                document.getElementById('blurBackground_settingShow').style.display = 'none';
                blurToggle.checked = false;
                localStorage.setItem('blur', 'no');
            } else {
                blurToggle.disabled = false;
                document.getElementById('blurBackground_settingShow').style.display = 'block';
            }
        }
        function applyBlur() {
            const bgDiv = document.getElementById('bg');
            if (localStorage.getItem('blur') === 'yes') {
                bgDiv.style.filter = 'blur(5px)';
            } else {
                bgDiv.style.filter = 'none';
            }
        }
        document.getElementById('theme').onchange = function() {
            const value = this.value;
            const customUpload = document.getElementById('customUpload');
            if (value === 'upload') {
                customUpload.style.display = 'block';
            } else {
                customUpload.style.display = 'none';
                localStorage.setItem('theme', value);
                setTheme(value);
            }
        };
        document.getElementById('uploadCustom').onclick = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const dataURL = ev.target.result;
                        const newBg = { name: file.name, data: dataURL };
                        customBackgrounds.push(newBg);
                        localStorage.setItem('customBackgrounds', JSON.stringify(customBackgrounds));
                        applyTranslations();
                        const newValue = `custom_${customBackgrounds.length - 1}`;
                        document.getElementById('theme').value = newValue;
                        localStorage.setItem('theme', newValue);
                        setTheme(newValue);
                        document.getElementById('customUpload').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert(lang === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : 'Please select an image');
                }
            };
            input.click();
        };
        document.getElementById('blurToggle').onchange = function() {
            localStorage.setItem('blur', this.checked ? 'yes' : 'no');
            applyBlur();
        };
        document.getElementById('animationsToggle').onchange = function() {
            localStorage.setItem('animations', this.checked ? 'yes' : 'no');
            applyAnimations();
        };
        function applyAnimations() {
            if (localStorage.getItem('animations') === 'no') {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }
        }
        document.getElementById('snowToggle').onchange = function() {
            localStorage.setItem('snow', this.checked ? 'yes' : 'no');
            applySnow();
        };
        function applySnow() {
            const snowCanvas = document.getElementById('snowCanvas');
            const snowPile = document.getElementById('snowPile');
            if (localStorage.getItem('snow') === 'yes') {
                snowCanvas.style.display = 'block';
                snowPile.style.display = 'block';
            } else {
                snowCanvas.style.display = 'none';
                snowPile.style.display = 'none';
            }
        }
        // Init theme and blur
        if (!localStorage.getItem('blur')) {
            localStorage.setItem('blur', 'no');
        }
        document.getElementById('blurToggle').checked = localStorage.getItem('blur') === 'yes';
        if (!localStorage.getItem('animations')) {
            localStorage.setItem('animations', 'yes');
        }
        document.getElementById('animationsToggle').checked = localStorage.getItem('animations') === 'yes';
        applyAnimations();
        if (!localStorage.getItem('snow')) {
            localStorage.setItem('snow', 'yes');
        }
        document.getElementById('snowToggle').checked = localStorage.getItem('snow') === 'yes';
        applySnow();
        let storedTheme = localStorage.getItem('theme') || 'theme1';
        if (storedTheme === 'upload') {
            storedTheme = 'theme1';
            localStorage.setItem('theme', 'theme1');
        }
        setTheme(storedTheme);
        //–ù–∞—á–∞–ª–æ –∫–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞
        const canvas = document.getElementById('glCanvas');
        const gl = canvas.getContext('webgl2');
        if (!gl) {
            console.error('WebGL 2 not supported');
            document.body.innerHTML = 'WebGL 2 is not supported in your browser.';
        }
        const vertexShaderSource = `#version 300 es
        in vec4 aPosition;
        void main() {
            gl_Position = aPosition;
        }`;
        const fragmentShaderSource = `#version 300 es
        precision highp float;
        uniform vec3 iResolution;
        uniform float iTime;
        uniform vec4 iMouse;
        out vec4 fragColor;
        /*--- BEGIN OF SHADERTOY ---*/
        /*
        Snowflakes
        https://www.shadertoy.com/view/Xsd3zf
        */
        /* Panteleymonov Aleksandr Konstantinovich 2015
        */
        #define iterations 10.0
        #define depth 0.0125
        #define layers 4.0
        #define layersblob 4
        #define step 1.1
        #define far 1000.0
        float radius = 0.21;
        float zoom = 2.5;
        float dist = 0.9;
        vec3 light=vec3(0.0,0.0,1.0);
        vec2 seed=vec2(0.0,0.0);
        float iteratorc=iterations;
        float powr;
        float res;
        vec4 NC0=vec4(0.0,157.0,113.0,270.0);
        vec4 NC1=vec4(1.0,158.0,114.0,271.0);
        lowp vec4 hash4( mediump vec4 n ) { return fract(sin(n)*1399763.5453123); }
        lowp float noise2( mediump vec2 x ) {
            vec2 p = floor(x);
            lowp vec2 f = fract(x);
            f = f*f*(3.0-2.0*f);
            float n = p.x + p.y*157.0;
            lowp vec4 h = hash4(vec4(n)+vec4(NC0.xy,NC1.xy));
            lowp vec2 s1 = mix(h.xy,h.zw,f.xx);
            return mix(s1.x,s1.y,f.y);
        }
        lowp float noise222( mediump vec2 x, mediump vec2 y, mediump vec2 z ) {
            mediump vec4 lx = vec4(x*y.x,x*y.y);
            mediump vec4 p = floor(lx);
            lowp vec4 f = fract(lx);
            f = f*f*(3.0-2.0*f);
            mediump vec2 n = p.xz + p.yw*157.0;
            lowp vec4 h = mix(hash4(n.xxyy+NC0.xyxy),hash4(n.xxyy+NC1.xyxy),f.xxzz);
            return dot(mix(h.xz,h.yw,f.yw),z);
        }
        lowp float noise3( mediump vec3 x ) {
            mediump vec3 p = floor(x);
            lowp vec3 f = fract(x);
            f = f*f*(3.0-2.0*f);
            mediump float n = p.x + dot(p.yz,vec2(157.0,113.0));
            lowp vec4 s1 = mix(hash4(vec4(n)+NC0),hash4(vec4(n)+NC1),f.xxxx);
            return mix(mix(s1.x,s1.y,f.y),mix(s1.z,s1.w,f.y),f.z);
        }
        lowp vec2 noise3_2( mediump vec3 x ) { return vec2(noise3(x),noise3(x+100.0)); }
        float map(mediump vec2 rad) {
            float a;
            if (res<0.0015) {
             //a = noise2(rad.xy*20.6)*0.9+noise2(rad.xy*100.6)*0.1;
                a = noise222(rad.xy,vec2(20.6,100.6),vec2(0.9,0.1));
            } else if (res<0.005) {
                //float a1 = mix(noise2(rad.xy*10.6),1.0,l);
                //a = texture(iChannel0,rad*0.3).x;
                a = noise2(rad.xy*20.6);
                //if (a1<a) a=a1;
            } else a = noise2(rad.xy*10.3);
            return (a-0.5);
        }
        vec3 distObj(vec3 pos,vec3 ray,float r,vec2 seed)
        {
            mediump float rq = r*r;
            mediump vec3 dist = ray*far;
          
            mediump vec3 norm = vec3(0.0,0.0,1.0);
            mediump float invn = 1.0/dot(norm,ray);
            mediump float depthi = depth;
            if (invn<0.0) depthi =- depthi;
            mediump float ds = 2.0*depthi*invn;
            mediump vec3 r1 = ray*(dot(norm,pos)-depthi)*invn-pos;
            mediump vec3 op1 = r1+norm*depthi;
            mediump float len1 = dot(op1,op1);
            mediump vec3 r2 = r1+ray*ds;
            mediump vec3 op2 = r2-norm*depthi;
            mediump float len2 = dot(op2,op2);
          
            mediump vec3 n = normalize(cross(ray,norm));
            mediump float mind = dot(pos,n);
            mediump vec3 n2 = cross(ray,n);
            mediump float d = dot(n2,pos)/dot(n2,norm);
            mediump float invd = 0.2/depth;
          
            if ((len1<rq || len2<rq) || (abs(mind)<r && d<=depth && d>=-depth))
            {
                mediump vec3 r3 = r2;
                mediump float len = len1;
                if (len>=rq) {
                 mediump vec3 n3 = cross(norm,n);
                 mediump float a = inversesqrt(rq-mind*mind)*abs(dot(ray,n3));
                    mediump vec3 dt = ray/a;
                 r1 =- d*norm-mind*n-dt;
                    if (len2>=rq) {
                        r2 =- d*norm-mind*n+dt;
                    }
                    ds = dot(r2-r1,ray);
                }
                ds = (abs(ds)+0.1)/(iterations);
                ds = mix(depth,ds,0.2);
                if (ds>0.01) ds=0.01;
                mediump float ir = 0.35/r;
                r *= zoom;
                ray = ray*ds*5.0;
                for (float m=0.0; m<iterations; m+=1.0) {
                    if (m>=iteratorc) break;
                    mediump float l = length(r1.xy); //inversesqrt(dot(r1.xy,r1.xy));
                    lowp vec2 c3 = abs(r1.xy/l);
                    if (c3.x>0.5) c3=abs(c3*0.5+vec2(-c3.y,c3.x)*0.86602540);
        mediump float g = l+c3.x*c3.x; //*1.047197551;
        l *= zoom;
                    mediump float h = l-r-0.1;
                    l = pow(l,powr)+0.1;
                   h = max(h,mix(map(c3*l+seed),1.0,abs(r1.z*invd)))+g*ir-0.245; //0.7*0.35=0.245 //*0.911890636
                    if ((h<res*20.0) || abs(r1.z)>depth+0.01) break;
                    r1 += ray*h;
                    ray*=0.99;
                }
                if (abs(r1.z)<depth+0.01) dist=r1+pos;
            }
            return dist;
        }
        vec3 nray;
        vec3 nray1;
        vec3 nray2;
        float mxc=1.0;
        vec4 filterFlake(vec4 color,vec3 pos,vec3 ray,vec3 ray1,vec3 ray2)
        {
            vec3 d=distObj(pos,ray,radius,seed);
            vec3 n1=distObj(pos,ray1,radius,seed);
            vec3 n2=distObj(pos,ray2,radius,seed);
            vec3 lq=vec3(dot(d,d),dot(n1,n1),dot(n2,n2));
        if (lq.x<far || lq.y<far || lq.z<far) {
             vec3 n=normalize(cross(n1-d,n2-d));
                if (lq.x<far && lq.y<far && lq.z<far) {
                nray = n;//normalize(nray+n);
                //nray1 = normalize(ray1+n);
                //nray2 = normalize(ray2+n);
                }
                float da = pow(abs(dot(n,light)),3.0);
                vec3 cf = mix(vec3(0.0,0.4,1.0),color.xyz*10.0,abs(dot(n,ray)));
                cf=mix(cf,vec3(2.0),da);
               color.xyz = mix(color.xyz,cf,mxc*mxc*(0.5+abs(dot(n,ray))*0.5));
            }
          
            return color;
        }
        void mainImage( out vec4 fragColor, in vec2 fragCoord )
        {
            float time = iTime*0.2;//*0.1;
            res = 1.0 / iResolution.y;
        vec2 p = (-iResolution.xy + 2.0*fragCoord.xy) *res;
            vec3 rotate;
          
            mat3 mr;
          
            vec3 ray = normalize(vec3(p,2.0));
            vec3 ray1;
            vec3 ray2;
            vec3 pos = vec3(0.0,0.0,1.0);
            fragColor = vec4(0.0,0.0,0.0,0.0);
          
        nray = vec3(0.0);
        nray1 = vec3(0.0);
        nray2 = vec3(0.0);
          
            vec4 refcolor=vec4(0.0);
            iteratorc=iterations-layers;
          
            vec2 addrot = vec2(0.0);
          
            float mxcl = 1.0;
            vec3 addpos=vec3(0.0);
            pos.z = dist;
            mxc = 1.0;
            //radius = 0.29;
            float mzd=(zoom-0.1)/layers;
            for (int i=0; i<layersblob;i++) {
                vec2 p2 = p-vec2(0.25)+vec2(0.1*float(i));
                ray = vec3(p2,2.0)-nray*2.0;
             //ray = nray;//*0.6;
             ray1 = normalize(ray+vec3(0.0,res*2.0,0.0));
             ray2 = normalize(ray+vec3(res*2.0,0.0,0.0));
                ray = normalize(ray);
             vec2 sb = ray.xy*length(pos)/dot(normalize(pos),ray)+vec2(0.0,time);
                seed=floor((sb+vec2(0.0,pos.z)))+pos.z;
                vec3 seedn = vec3(seed,pos.z);
                sb = floor(sb);
                if (noise3(seedn)>0.2 && i<int(layers)) {
                    powr = noise3(seedn*10.0)*1.9+0.1;
                    rotate.xy=sin((0.5-noise3_2(seedn))*time*5.0)*0.3+addrot;
                    rotate.z = (0.5-noise3(seedn+vec3(10.0,3.0,1.0)))*time*5.0;
                    seedn.z += time*0.5;
                    addpos.xy = sb+vec2(0.25,0.25-time)+noise3_2(seedn)*0.5;
                    vec3 sins = sin(rotate);
             vec3 coss = cos(rotate);
             mr=mat3(vec3(coss.x,0.0,sins.x),vec3(0.0,1.0,0.0),vec3(-sins.x,0.0,coss.x));
            mr=mat3(vec3(1.0,0.0,0.0),vec3(0.0,coss.y,sins.y),vec3(0.0,-sins.y,coss.y))*mr;
                    mr=mat3(vec3(coss.z,sins.z,0.0),vec3(-sins.z,coss.z,0.0),vec3(0.0,0.0,1.0))*mr;
                    light = normalize(vec3(1.0,0.0,1.0))*mr;
             //vec4 cc=filterFlake(fragColor,(pos+addpos)*mr,normalize(ray*mr+nray*0.1),normalize(ray1*mr+nray*0.1),normalize(ray2*mr+nray*0.1));
                    vec4 cc = filterFlake(fragColor,(pos+addpos)*mr,ray*mr,ray1*mr,ray2*mr);
                    //if (i>0 && dot(nray,nray)!=0.0 && dot(nray1,nray1)!=0.0 && dot(nray2,nray2)!=0.0) refcolor=filterFlake(refcolor,(pos+addpos)*mr,nray,nray1,nray2);
                    //cc+=refcolor*0.5;
                    fragColor=mix(cc,fragColor,min(1.0,fragColor.w));
                }
                seedn = vec3(sb,pos.z)+vec3(0.5,1000.0,300.0);
                if (noise3(seedn*10.0)>0.4) {
                    float raf = 0.3+noise3(seedn*100.0);
                    addpos.xy = sb+vec2(0.2,0.2-time)+noise3_2(seedn*100.0)*0.6;
                    float l = length(ray*dot(ray,pos+addpos)-pos-addpos);
                    l = max(0.0,(1.0-l*10.0*raf));
                    fragColor.xyzw += vec4(1.0,1.2,3.0,1.0)*pow(l,5.0)*(pow(0.6+raf,2.0)-0.6)*mxcl;
                }
                mxc -= 1.1/layers;
                pos.z += step;
                pos.x += 0.1 * sin(3.0 * time);
                iteratorc += 2.0;
                mxcl -= 1.1/float(layersblob);
                zoom-= mzd;
            }
          
            vec3 cr = mix(vec3(0.0),vec3(0.0,0.0,0.4),(-0.55+p.y)*2.0);
            fragColor.xyz += mix((cr.xyz-fragColor.xyz)*0.1,vec3(0.2,0.5,1.0),clamp((-p.y+1.0)*0.5,0.0,1.0));
          
            fragColor = min( vec4(1.0), fragColor );
            fragColor.a = 1.0;
        }
        /*--- END OF SHADERTOY ---*/
        void main() {
            mainImage(fragColor, gl_FragCoord.xy);
        }
        `;
        function createShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                console.error('Shader compile error:', gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }
            return shader;
        }
        function createProgram(gl, vertexShader, fragmentShader) {
            const program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                console.error('Program link error:', gl.getProgramInfoLog(program));
                gl.deleteProgram(program);
                return null;
            }
            return program;
        }
        const vertexShader = createShader(gl, gl.VERTEX_SHADER, vertexShaderSource);
        const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fragmentShaderSource);
        const program = createProgram(gl, vertexShader, fragmentShader);
        const positionAttributeLocation = gl.getAttribLocation(program, 'aPosition');
        const resolutionUniformLocation = gl.getUniformLocation(program, 'iResolution');
        const timeUniformLocation = gl.getUniformLocation(program, 'iTime');
        const mouseUniformLocation = gl.getUniformLocation(program, 'iMouse');
        const positionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]), gl.STATIC_DRAW);
        gl.useProgram(program);
        gl.enableVertexAttribArray(positionAttributeLocation);
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.vertexAttribPointer(positionAttributeLocation, 2, gl.FLOAT, false, 0, 0);
        let mouseX = 0, mouseY = 0;
        canvas.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = canvas.height - e.clientY; // Flip Y coordinate
        });
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // Call once to set initial size
        function render(time) {
            gl.uniform3f(resolutionUniformLocation, gl.canvas.width, gl.canvas.height, 1.0);
            gl.uniform1f(timeUniformLocation, time * 0.001);
            gl.uniform4f(mouseUniformLocation, mouseX, mouseY, 0.0, 0.0);
            gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
            requestAnimationFrame(render);
        }
        requestAnimationFrame(render);
        /*
        // Fullscreen toggle functionality
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        fullscreenBtn.addEventListener('click', toggleFullScreen);
        function toggleFullScreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
          } else {
            if (document.exitFullscreen) {
              document.exitFullscreen();
            }
          }
        }
        */
        //–ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –≥–æ–¥–∞
    </script>
</body>
</html>