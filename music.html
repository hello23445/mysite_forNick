<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –°—Ç—É–¥–∏—è</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    /* –û–±—â–∏–π —Å—Ç–∏–ª—å */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-y: auto; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
      overflow-x: hidden; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
      touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    .container {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      background: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 15px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    section {
      margin-bottom: 25px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã */
    }
    section h2 {
      margin-top: 0;
      color: #444;
      display: inline-block;
      vertical-align: middle;
      font-size: 1.2em; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    /* –ö–Ω–æ–ø–∫–∞ "?" ‚Äì –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ */
    .info-btn {
      background: #4CAF50;
      border: none;
      border-radius: 50%;
      width: 20px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Ä–∞–∑–º–µ—Ä */
      height: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 5px;
      cursor: pointer;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
    }
    button, input[type="file"] {
      padding: 8px 16px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã */
      font-size: 0.9em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 8px;
      background: #66a6ff;
      color: #fff;
      transition: background 0.2s;
      touch-action: manipulation;
    }
    button:hover {
      background: #5594e6;
    }
    button:disabled {
      background: #a3c4ff;
      cursor: not-allowed;
    }
    .control-group {
      margin-bottom: 12px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã */
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: bold;
      font-size: 0.9em;
    }
    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      background: #ddd;
      height: 6px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –≤—ã—Å–æ—Ç—É */
      border-radius: 4px;
      outline: none;
      touch-action: manipulation;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; /* –£–º–µ–Ω—å—à–∏–ª–∏ —Ä–∞–∑–º–µ—Ä */
      height: 18px;
      border-radius: 50%;
      background: #66a6ff;
      cursor: pointer;
      transition: background 0.2s;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      background: #5594e6;
    }
    .value-display {
      text-align: right;
      font-size: 0.8em;
      margin-top: 4px;
    }
    audio {
      width: 100%;
      margin-top: 8px;
      outline: none;
    }
    /* –ë–ª–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .extra-tools-section {
      margin-bottom: 25px;
    }
    #toggleExtra {
      background: #ffb74d;
      color: #fff;
      margin-bottom: 8px;
      width: 100%; /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    #extraTools {
      display: none;
      border-top: 1px solid #ccc;
      padding-top: 12px;
    }
    .extra-control {
      margin-bottom: 8px;
    }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
    }
    .modal-content {
      background: #fff;
      color: #333;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      max-width: 90%;
      width: auto;
      max-height: 80vh;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .modal-content p {
      margin: 8px 0;
    }
    .modal-content ul {
      list-style: none;
      padding: 0;
      text-align: left;
    }
    .modal-content li {
      margin: 4px 0;
    }
    .modal-content button {
      margin-top: 8px;
      padding: 4px 8px;
      border: none;
      border-radius: 5px;
      background: #66a6ff;
      color: #fff;
      cursor: pointer;
    }
    /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ */
    #resetBaseBtn {
      margin-top: 12px;
      background: #e57373;
    }
    /* –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ */
    .upload-section input[type="file"] {
      display: block;
      margin-top: 8px;
      width: 100%;
    }
    /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –Ω–∞ —Ñ–æ–Ω–µ */
    canvas#visualizerBackground {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: none;
    }
    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" */
    #backBtn {
      padding: 8px 16px;
      font-size: 14px;
      z-index: 999;
      position: fixed;
      top: 10px;
      left: 10px;
    }
    /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 600px) {
      .container {
        margin: 10px;
        padding: 10px;
      }
      section h2 {
        font-size: 1.1em;
      }
      button, input[type="file"] {
        padding: 6px 12px;
        font-size: 0.8em;
      }
      .info-btn {
        width: 18px;
        height: 18px;
        font-size: 11px;
      }
      input[type="range"] {
        height: 5px;
      }
      input[type="range"]::-webkit-slider-thumb {
        width: 16px;
        height: 16px;
      }
      .value-display {
        font-size: 0.75em;
      }
      .modal-content {
        padding: 10px;
        max-height: 70vh;
      }
      /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–∫–∞ —Å–≤–µ—Ä—Ö—É –Ω–∞–¥–ø–∏—Å–∏, –Ω–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è */
      #backBtn {
        position: static;
        display: block;
        margin: 0 auto 20px auto;
        width: fit-content;
      }
      .play-section {
        margin-top: 0; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è —Å–µ–∫—Ü–∏–∏ */
      }
    }
    /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–ø—Ä–∞–≤–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–Ω–∞ —Å–ø—Ä–∞–≤–∞) */
    /* –ù–µ—Ç –Ω—É–∂–¥—ã –¥–æ–±–∞–≤–ª—è—Ç—å —á—Ç–æ-—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–ø—Ä–∞–≤–∞ */
  </style>
</head>
<body>
  <!-- –§–æ–Ω —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–º -->
  <canvas id="visualizerBackground"></canvas>
  
  <div class="container">
    <button id="backBtn" onclick="window.location.href = 'main.html'">
      –í–ï–†–ù–£–¢–¨–°–Ø –í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ
    </button>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
    <section class="upload-section">
      <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–≤–æ—é –ø–µ—Å–Ω—é</h2>
      <input type="file" id="audioUpload" accept="audio/*">
    </section>
    
    <!-- –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –∏ –±–∞–∑–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
    <section class="play-section">
      <h2>
        –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –∏ –±–∞–∑–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        <button id="baseInfoBtn" class="info-btn" type="button" data-info="–ì—Ä–æ–º–∫–æ—Å—Ç—å: –£–ø—Ä–∞–≤–ª—è–µ—Ç —É—Ä–æ–≤–Ω–µ–º –∑–≤—É–∫–∞ —á–µ—Ä–µ–∑ —É—Å–∏–ª–∏—Ç–µ–ª—å. –ó–Ω–∞—á–µ–Ω–∏–µ 1 ‚Äì –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ, –º–µ–Ω—å—à–µ 1 ‚Äì —Ç–∏—à–µ, –±–æ–ª—å—à–µ 1 ‚Äì –≥—Ä–æ–º—á–µ.&#10;–ó–∞–¥–µ—Ä–∂–∫–∞: –î–æ–±–∞–≤–ª—è–µ—Ç —ç—Ö–æ; 0 ‚Äì –±–µ–∑ —ç—Ö–∞.">?</button>
      </h2>
      <!-- –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á—ë–Ω ‚Äì –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç Play -->
      <audio id="audioPlayer" controls></audio>
      <div class="control-group">
        <label for="volumeControl">–ì—Ä–æ–º–∫–æ—Å—Ç—å (0 - 24):
          <button class="info-btn" data-info="–ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏. –ó–Ω–∞—á–µ–Ω–∏–µ 1 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—Å–∏–ª–µ–Ω–∏—è. –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∑–≤—É–∫ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≥—Ä–æ–º—á–µ, –ø—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ ‚Äì —Ç–∏—à–µ." type="button">?</button>
        </label>
        <input type="range" id="volumeControl" min="0" max="24" step="0.01" value="1">
        <div class="value-display">–ó–Ω–∞—á–µ–Ω–∏–µ: <span id="volumeValue">1.00</span></div>
      </div>
      <div class="control-group">
        <label for="delayControl">–≠—Ñ—Ñ–µ–∫—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ (0 - 1 —Å–µ–∫):
          <button class="info-btn" data-info="–ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ (—ç—Ö–æ). –ó–Ω–∞—á–µ–Ω–∏–µ 0 ‚Äì –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞, –∞ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã –¥–æ–±–∞–≤–ª—è—é—Ç —ç—Ö–æ." type="button">?</button>
        </label>
        <input type="range" id="delayControl" min="0" max="1" step="0.01" value="0">
        <div class="value-display">–ó–Ω–∞—á–µ–Ω–∏–µ: <span id="delayValue">0.00</span> —Å–µ–∫</div>
      </div>
    </section>
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section class="extra-tools-section">
      <button id="toggleExtra">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å‚¨áÔ∏è</button>
      <div id="extraTools">
        <h2>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div id="extraControls"><!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ --></div>
      </div>
    </section>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è -->
    <section class="share-section">
      <button id="shareMusicBtn" disabled>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º—É–∑—ã–∫–æ–π (Premium)</button>
    </section>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (–æ—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞) -->
  <div id="overlay" class="modal-overlay">
    <div class="modal-content">
      –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω.<br>
      –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –µ–≥–æ!
      <br>
      <button id="closeOverlay">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div id="infoModal" class="modal-overlay">
    <div class="modal-content" id="infoModalContent">
      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      <button id="closeInfoModal">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
  
  <script>
    // –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ (–∑–∞–ø–æ–º–Ω–µ–Ω–Ω–∞—è)
    let originalFileName = '';
    let audioFile = null; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞
    const audioPlayer = document.getElementById('audioPlayer');
    const audioUpload = document.getElementById('audioUpload');
    const shareMusicBtn = document.getElementById('shareMusicBtn');
    const volumeControl = document.getElementById('volumeControl');
    const volumeValue = document.getElementById('volumeValue');
    const delayControl = document.getElementById('delayControl');
    const delayValue = document.getElementById('delayValue');
    
    // –í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ (–∑–∞–ø–æ–º–Ω–µ–Ω–Ω–∞—è)
    const extraTools = document.getElementById('extraTools');
    const extraControlsContainer = document.getElementById('extraControls');
    const closeOverlay = document.getElementById('closeOverlay');
    const baseInfoBtn = document.getElementById('baseInfoBtn');
    
    const infoModal = document.getElementById('infoModal');
    const infoModalContent = document.getElementById('infoModalContent');
    const closeInfoModal = document.getElementById('closeInfoModal');
    
    let audioContext, sourceNode, gainNode, delayNode;
    let extraEffects = [];
    let extraControlsGenerated = false;
    let bypassExtraEffects = true; // –§–ª–∞–≥: –µ—Å–ª–∏ –≤—Å–µ extra-—Å–ª–∞–π–¥–µ—Ä—ã –Ω–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ ‚Äì —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–º–∏—É–º–∞
    const premium = localStorage.getItem('premium');
    if (premium) {
      shareMusicBtn.disabled = false;
      shareMusicBtn.textContent = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º—É–∑—ã–∫–æ–π';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º—É–∑—ã–∫–æ–π"
    shareMusicBtn.addEventListener('click', async () => {
      if (!audioFile) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å –ø–µ—Å–Ω–µ–π.");
        return;
      }
      shareMusicBtn.disabled = true;
      const processedBlob = await renderProcessedAudio();
      shareMusicBtn.disabled = false;
      if (!processedBlob) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—É–¥–∏–æ.");
        return;
      }
      const fileExt = originalFileName.split('.').pop();
      const newFileName = originalFileName.replace(`.${fileExt}`, `_processed.wav`);
      const processedFile = new File([processedBlob], newFileName, {type: 'audio/wav'});
      const settingsText = getCurrentSettings();
      if (navigator.canShare && navigator.canShare({ files: [processedFile] })) {
        try {
          await navigator.share({
            title: '–ú–æ—è –º—É–∑—ã–∫–∞',
            text: settingsText,
            files: [processedFile]
          });
        } catch (error) {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è: " + error);
        }
      } else {
        alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤.");
      }
    });
    
    function getCurrentSettings() {
      let settings = "–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n";
      settings += "–ì—Ä–æ–º–∫–æ—Å—Ç—å: " + volumeControl.value + "\n";
      settings += "–ó–∞–¥–µ—Ä–∂–∫–∞: " + delayControl.value + " —Å–µ–∫\n\n";
      settings += "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n";
      for (let i = 0; i < extraEffectsConfig.length; i++) {
        const slider = document.getElementById('extraControl' + i);
        if (slider) {
          settings += extraEffectsConfig[i].name + ": " + slider.value + "\n";
        }
      }
      return settings;
    }
    
    // –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    function rebuildExtraEffectsChain() {
      delayNode.disconnect();
      if (extraEffects.length > 0) {
        delayNode.connect(extraEffects[0].node);
        for (let i = 0; i < extraEffects.length - 1; i++) {
          try { extraEffects[i].node.disconnect(); } catch(e){}
          extraEffects[i].node.connect(extraEffects[i+1].node);
        }
        try { extraEffects[extraEffects.length - 1].node.disconnect(); } catch(e){}
        extraEffects[extraEffects.length - 1].node.connect(audioContext.destination);
        bypassExtraEffects = false;
      } else {
        delayNode.connect(audioContext.destination);
        bypassExtraEffects = true;
      }
    }
    
    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ª–∞–π–¥–µ—Ä–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function extraSliderChanged() {
      rebuildExtraEffectsChain();
    }
    
    // –°–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ (info)
    const extraEffectsConfig = [
      { name: 'Lowshelf (Bass, –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∏–∑–∫–∏–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏)', type: 'lowshelf', min: -20, max: 20, step: 1, value: 0, info: '–≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∏–∑–∫–∏–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏. –ü—Ä–∏ –∑–Ω–∞—á–µ–Ω–∏–∏ 0 –∑–≤—É–∫ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è, –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —É—Å–∏–ª–∏–≤–∞—é—Ç –±–∞—Å, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ‚Äì —É–º–µ–Ω—å—à–∞—é—Ç –µ–≥–æ.' },
      { name: 'Distortion (–ò—Å–∫–∞–∂–µ–Ω–∏–µ)', type: 'distortion', min: 0, max: 1000, step: 1, value: 0, info: '–≠—Ñ—Ñ–µ–∫—Ç –∏—Å–∫–∞–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É, —Å–æ–∑–¥–∞–≤–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ–µ ¬´–≥—Ä—è–∑–Ω–æ–µ¬ª –∑–≤—É—á–∞–Ω–∏–µ. –ó–Ω–∞—á–µ–Ω–∏–µ 0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è.' },
      { name: 'Highpass (–£–±–∏—Ä–∞–µ—Ç –Ω–∏–∑–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã)', type: 'highpass', min: 20, max: 2000, step: 1, value: 20, info: '–§–∏–ª—å—Ç—Ä Highpass –æ—Ç—Å–µ–∫–∞–µ—Ç –Ω–∏–∑–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –Ω–∏–∂–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞. –ó–Ω–∞—á–µ–Ω–∏–µ 20 –ì—Ü ‚Äì –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç—Å–µ—á–µ–Ω–∏–µ.' },
      { name: 'Lowpass (–£–±–∏—Ä–∞–µ—Ç –≤—ã—Å–æ–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã)', type: 'lowpass', min: 1000, max: 22050, step: 1, value: 22050, info: '–§–∏–ª—å—Ç—Ä Lowpass –æ—Ç—Å–µ–∫–∞–µ—Ç –≤—ã—Å–æ–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã –≤—ã—à–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –ü—Ä–∏ 22050 –ì—Ü —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.' },
      { name: 'Panner (–°—Ç–µ—Ä–µ–æ–ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)', type: 'panner', min: -1, max: 1, step: 0.01, value: 0, info: '–ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –∑–≤—É–∫–∞ –≤ —Å—Ç–µ—Ä–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ. –ó–Ω–∞—á–µ–Ω–∏–µ 0 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–≤—É–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä—É.' },
      { name: 'Compressor (–°–∂–∞—Ç–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞)', type: 'compressor', min: -100, max: 0, step: 1, value: -100, info: '–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä —É–º–µ–Ω—å—à–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω, –¥–µ–ª–∞—è –ø–∏–∫–∏ –∑–≤—É–∫–∞ –º–µ–Ω–µ–µ —Ä–µ–∑–∫–∏–º–∏. –ó–Ω–∞—á–µ–Ω–∏–µ -100 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏.' },
      { name: 'Delay (–í—Ç–æ—Ä–∏—á–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞)', type: 'delay', min: 0, max: 0.5, step: 0.01, value: 0, info: '–≠—Ñ—Ñ–µ–∫—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç—Ö–æ. –ó–Ω–∞—á–µ–Ω–∏–µ 0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏.' },
      { name: 'Notch (–§–∏–ª—å—Ç—Ä Notch)', type: 'notch', min: 0, max: 2000, step: 1, value: 0, info: 'Notch-—Ñ–∏–ª—å—Ç—Ä —É–¥–∞–ª—è–µ—Ç —É–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω —á–∞—Å—Ç–æ—Ç –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑–æ–Ω–∞–Ω—Å–æ–≤.' },
      { name: 'Peaking (–≠–∫–≤–∞–ª–∞–π–∑–µ—Ä)', type: 'peaking', min: -20, max: 20, step: 1, value: 0, info: 'Peaking-—Ñ–∏–ª—å—Ç—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Å–∏–ª–∏—Ç—å –∏–ª–∏ –æ—Å–ª–∞–±–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω —á–∞—Å—Ç–æ—Ç. –ó–Ω–∞—á–µ–Ω–∏–µ 0 ‚Äì –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.' },
      { name: 'Gain Booster (–£—Å–∏–ª–µ–Ω–∏–µ)', type: 'gain', min: 1, max: 3, step: 0.01, value: 1, info: '–≠—Ç–æ—Ç —É—Å–∏–ª–∏—Ç–µ–ª—å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª–∞. –ó–Ω–∞—á–µ–Ω–∏–µ 1 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—Å–∏–ª–µ–Ω–∏—è.' },
      { name: 'Tremolo (–ú–æ–¥—É–ª—è—Ü–∏—è –∞–º–ø–ª–∏—Ç—É–¥—ã)', type: 'tremolo', min: 0, max: 1, step: 0.01, value: 0, info: '–¢—Ä–µ–º–æ–ª–æ —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç –ø—É–ª—å—Å–∞—Ü–∏–∏ –∑–≤—É–∫–∞ –∑–∞ —Å—á–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –º–æ–¥—É–ª—è—Ü–∏–∏ –∞–º–ø–ª–∏—Ç—É–¥—ã. –ü—Ä–∏ 0 —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç.' },
      { name: 'Bandpass (–ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —É–∑–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω)', type: 'bandpass', min: 0, max: 3000, step: 1, value: 0, info: 'Bandpass-—Ñ–∏–ª—å—Ç—Ä –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω —á–∞—Å—Ç–æ—Ç. –ü—Ä–∏ 0 —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.' },
      { name: 'Allpass (–§–∞–∑–æ–≤—ã–π —Å–¥–≤–∏–≥)', type: 'allpass', min: 300, max: 3000, step: 1, value: 1000, info: 'Allpass-—Ñ–∏–ª—å—Ç—Ä –∏–∑–º–µ–Ω—è–µ—Ç —Ñ–∞–∑—É —Å–∏–≥–Ω–∞–ª–∞, –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è –∞–º–ø–ª–∏—Ç—É–¥—É. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.' },
      { name: 'Highshelf (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ–∫–∏–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏)', type: 'highshelf', min: -20, max: 20, step: 1, value: 0, info: '–≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Å–æ–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã, –≤–ª–∏—è—è –Ω–∞ —è—Ä–∫–æ—Å—Ç—å –∏ —á–µ—Ç–∫–æ—Å—Ç—å –∑–≤—É–∫–∞. –ó–Ω–∞—á–µ–Ω–∏–µ 0 ‚Äì –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.' },
      { name: 'Reverb (–†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è)', type: 'reverb', min: 0, max: 1, step: 0.01, value: 0, info: '–†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –∞–∫—É—Å—Ç–∏–∫—É –ø–æ–º–µ—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è—è –≥–ª—É–±–∏–Ω—É –∏ –æ–±—ä–µ–º –∑–≤—É–∫—É. –ó–Ω–∞—á–µ–Ω–∏–µ 0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏.' },
      { name: 'Flanger (–≠—Ñ—Ñ–µ–∫—Ç Flanger)', type: 'flanger', min: 0, max: 0.005, step: 0.0001, value: 0, info: 'Flanger —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç ¬´–≤—Ä–∞—â–µ–Ω–∏—è¬ª –∑–≤—É–∫–∞ –∑–∞ —Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏. –ü—Ä–∏ 0 —ç—Ñ—Ñ–µ–∫—Ç –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è.' },
      { name: 'Chorus (–≠—Ñ—Ñ–µ–∫—Ç Chorus)', type: 'chorus', min: 0, max: 0.03, step: 0.001, value: 0, info: 'Chorus –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–ª–µ–≥–∫–∞ —Å–º–µ—â–µ–Ω–Ω—ã–µ –∫–æ–ø–∏–∏ —Å–∏–≥–Ω–∞–ª–∞, –¥–µ–ª–∞—è –∑–≤—É–∫ —à–∏—Ä–µ –∏ –±–æ–≥–∞—á–µ. –ó–Ω–∞—á–µ–Ω–∏–µ 0 ‚Äì –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞.' },
      { name: 'Vibrato (–ú–æ–¥—É–ª—è—Ü–∏—è –≤—ã—Å–æ—Ç—ã —Ç–æ–Ω–∞)', type: 'vibrato', min: 0, max: 1, step: 0.01, value: 0, info: '–í–∏–±—Ä–∞—Ç–æ –∏–∑–º–µ–Ω—è–µ—Ç –≤—ã—Å–æ—Ç—É —Ç–æ–Ω–∞ –∑–≤—É–∫–∞, —Å–æ–∑–¥–∞–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–ª–µ–±–∞–Ω–∏–π. –ü—Ä–∏ 0 —ç—Ñ—Ñ–µ–∫—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.' },
      { name: 'Phaser (–§–∞–∑–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç)', type: 'phaser', min: 0, max: 1, step: 0.01, value: 0, info: '–§–∞–∑–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Å–æ–∑–¥–∞–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ–µ ¬´–≤—Ä–∞—â–∞—é—â–µ–µ—Å—è¬ª –∑–≤—É—á–∞–Ω–∏–µ –∑–∞ —Å—á–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ñ–∞–∑—ã —Å–∏–≥–Ω–∞–ª–∞. –ü—Ä–∏ 0 –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.' },
      { name: 'AutoWah (–≠—Ñ—Ñ–µ–∫—Ç Wah)', type: 'autowah', min: 0, max: 1, step: 0.01, value: 0, info: 'AutoWah –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å–∏–≥–Ω–∞–ª–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ –¥–∏–Ω–∞–º–∏–∫–∏, —Å–æ–∑–¥–∞–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç ¬´wah-wah¬ª. –ü—Ä–∏ 0 —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–µ—Ç.' },
      { name: 'Playback Rate (–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)', type: 'playbackRate', min: 0.5, max: 2.0, step: 0.01, value: 1, info: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–∑–º–µ–Ω—è–µ—Ç —Ç–µ–º–ø –∏ –≤—ã—Å–æ—Ç—É —Ç–æ–Ω–∞ –∑–≤—É–∫–∞. –ó–Ω–∞—á–µ–Ω–∏–µ 1 ‚Äì –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å.' },
      { name: 'Bitcrusher (–≠—Ñ—Ñ–µ–∫—Ç lo‚Äëfi)', type: 'bitcrusher', min: 1, max: 16, step: 1, value: 16, info: 'Bitcrusher —É–º–µ–Ω—å—à–∞–µ—Ç –±–∏—Ç–æ–≤—É—é –≥–ª—É–±–∏–Ω—É —Å–∏–≥–Ω–∞–ª–∞, —Å–æ–∑–¥–∞–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç lo‚Äëfi. –ó–Ω–∞—á–µ–Ω–∏–µ 16 –æ–∑–Ω–∞—á–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∑–≤—É—á–∞–Ω–∏–µ (–±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞).' }
    ];

    function createImpulseResponse(ctx, duration, decay) {
      const length = ctx.sampleRate * duration;
      const impulse = ctx.createBuffer(2, length, ctx.sampleRate);
      const impulseL = impulse.getChannelData(0);
      const impulseR = impulse.getChannelData(1);
      for (let i = 0; i < length; i++) {
        const n = decay ? Math.exp(-i / (ctx.sampleRate * decay)) : 1;
        impulseL[i] = (Math.random() * 2 - 1) * n;
        impulseR[i] = (Math.random() * 2 - 1) * n;
      }
      return impulse;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è extra-—ç—Ñ—Ñ–µ–∫—Ç–∞ —Å bypass-–ª–æ–≥–∏–∫–æ–π
    function createExtraEffect(cfg, ctx = audioContext) {
      let node;
      let extraData = { config: cfg };
      switch(cfg.type) {
        case 'lowshelf':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'lowshelf';
            node.frequency.value = 200;
            node.gain.value = cfg.value;
          }
          break;
        case 'distortion':
          node = ctx.createWaveShaper();
          node.curve = makeDistortionCurve(cfg.value);
          break;
        case 'highpass':
          if (cfg.value == 20) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'highpass';
            node.frequency.value = cfg.value;
          }
          break;
        case 'lowpass':
          if (cfg.value == 22050) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'lowpass';
            node.frequency.value = cfg.value;
          }
          break;
        case 'panner':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createStereoPanner();
            node.pan.value = cfg.value;
          }
          break;
        case 'compressor':
          if (cfg.value == -100) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createDynamicsCompressor();
            node.threshold.value = cfg.value;
          }
          break;
        case 'delay':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createDelay(1.0);
            node.delayTime.value = cfg.value;
          }
          break;
        case 'notch':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'notch';
            node.frequency.value = cfg.value;
          }
          break;
        case 'peaking':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'peaking';
            node.gain.value = cfg.value;
          }
          break;
        case 'gain':
          if (cfg.value == 1) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createGain();
            node.gain.value = cfg.value;
          }
          break;
        case 'tremolo':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createGain();
            node.gain.value = 1;
            const tremoloOsc = ctx.createOscillator();
            tremoloOsc.type = 'sine';
            tremoloOsc.frequency.value = 5;
            const tremoloGain = ctx.createGain();
            tremoloGain.gain.value = cfg.value;
            tremoloOsc.connect(tremoloGain);
            tremoloGain.connect(node.gain);
            tremoloOsc.start(0);
            extraData.tremoloOsc = tremoloOsc;
            extraData.tremoloGain = tremoloGain;
          }
          break;
        case 'bandpass':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'bandpass';
            node.frequency.value = cfg.value;
          }
          break;
        case 'allpass':
          node = ctx.createBiquadFilter();
          node.type = 'allpass';
          node.frequency.value = cfg.value;
          break;
        case 'highshelf':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createBiquadFilter();
            node.type = 'highshelf';
            node.frequency.value = 5000;
            node.gain.value = cfg.value;
          }
          break;
        case 'reverb':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            const convolver = ctx.createConvolver();
            convolver.buffer = createImpulseResponse(ctx, 2.0, 2.0);
            const reverbGain = ctx.createGain();
            reverbGain.gain.value = cfg.value;
            convolver.connect(reverbGain);
            node = reverbGain;
            extraData.convolver = convolver;
          }
          break;
        case 'flanger':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createDelay();
            node.delayTime.value = cfg.value;
            const flangerOsc = ctx.createOscillator();
            flangerOsc.type = 'sine';
            flangerOsc.frequency.value = 0.25;
            const flangerGain = ctx.createGain();
            flangerGain.gain.value = cfg.value;
            flangerOsc.connect(flangerGain);
            flangerGain.connect(node.delayTime);
            flangerOsc.start(0);
            extraData.flangerOsc = flangerOsc;
          }
          break;
        case 'chorus':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createDelay();
            node.delayTime.value = cfg.value;
            const chorusOsc = ctx.createOscillator();
            chorusOsc.type = 'sine';
            chorusOsc.frequency.value = 1.5;
            const chorusGain = ctx.createGain();
            chorusGain.gain.value = cfg.value;
            chorusOsc.connect(chorusGain);
            chorusGain.connect(node.delayTime);
            chorusOsc.start(0);
            extraData.chorusOsc = chorusOsc;
          }
          break;
        case 'vibrato':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createGain();
            node.gain.value = cfg.value;
          }
          break;
        case 'phaser':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createGain();
            node.gain.value = cfg.value;
          }
          break;
        case 'autowah':
          if (cfg.value == 0) {
            node = ctx.createGain();
            node.gain.value = 1;
          } else {
            node = ctx.createGain();
            node.gain.value = cfg.value;
          }
          break;
        case 'playbackRate':
          node = ctx.createGain();
          break;
        case 'bitcrusher':
          node = ctx.createScriptProcessor(4096, 1, 1);
          node.bits = cfg.value;
          node.onaudioprocess = function(e) {
            const input = e.inputBuffer.getChannelData(0);
            const output = e.outputBuffer.getChannelData(0);
            const step = Math.pow(0.5, node.bits);
            for (let i = 0; i < input.length; i++) {
              output[i] = step * Math.floor(input[i] / step + 0.5);
            }
          };
          break;
        default:
          node = ctx.createGain();
          node.gain.value = cfg.value;
      }
      extraData.node = node;
      return extraData;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–∏–≤–æ–π –¥–∏—Å—Ç–æ—Ä—à–Ω–∞ ‚Äì –µ—Å–ª–∏ amount —Ä–∞–≤–µ–Ω 0, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏–Ω–µ–π–Ω—É—é –∫—Ä–∏–≤—É—é
    function makeDistortionCurve(amount) {
      const n_samples = 44100;
      const curve = new Float32Array(n_samples);
      if (amount === 0) {
        for (let i = 0; i < n_samples; i++) {
          curve[i] = i * 2 / n_samples - 1;
        }
        return curve;
      }
      const deg = Math.PI / 180;
      for (let i = 0; i < n_samples; ++i) {
        const x = i * 2 / n_samples - 1;
        curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
      }
      return curve;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioContext –∏ —Ü–µ–ø–æ—á–∫–∏ —É–∑–ª–æ–≤
    function initAudioContext() {
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioContext.resume();
      // –ê—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç –æ—Å—Ç–∞–µ—Ç—Å—è muted ‚Äì –∑–≤—É–∫ –≤—ã–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ AudioContext
      audioPlayer.muted = true;
      
      sourceNode = audioContext.createMediaElementSource(audioPlayer);
      gainNode = audioContext.createGain();
      delayNode = audioContext.createDelay(2.0);
      
      extraEffects = extraEffectsConfig.map(cfg => createExtraEffect(cfg));
      
      sourceNode.connect(gainNode);
      gainNode.connect(delayNode);
      // –ï—Å–ª–∏ –≤—Å–µ extra-—Å–ª–∞–π–¥–µ—Ä—ã –Ω–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ, —Ü–µ–ø–æ—á–∫–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
      bypassExtraEffects = true;
      delayNode.connect(audioContext.destination);
      
      if (!extraControlsGenerated) {
        generateExtraControls();
        extraControlsGenerated = true;
      }
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è UI –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    function generateExtraControls() {
      extraEffects.forEach((effectData, index) => {
        const cfg = effectData.config;
        const controlDiv = document.createElement('div');
        controlDiv.classList.add('extra-control');
        
        const label = document.createElement('label');
        label.setAttribute('for', `extraControl${index}`);
        label.innerHTML = `${cfg.name}: `;
        const btn = document.createElement('button');
        btn.classList.add('info-btn');
        btn.type = "button";
        btn.textContent = "?";
        btn.addEventListener('click', () => {
          openInfoModal(cfg.info);
        });
        label.appendChild(btn);
        
        const slider = document.createElement('input');
        slider.type = 'range';
        slider.id = `extraControl${index}`;
        slider.min = cfg.min;
        slider.max = cfg.max;
        slider.step = cfg.step;
        slider.value = cfg.value;
        
        const valueDisplay = document.createElement('div');
        valueDisplay.classList.add('value-display');
        valueDisplay.textContent = `–ó–Ω–∞—á–µ–Ω–∏–µ: ${slider.value}`;
        
        slider.addEventListener('input', () => {
          const val = parseFloat(slider.value);
          valueDisplay.textContent = `–ó–Ω–∞—á–µ–Ω–∏–µ: ${slider.value}`;
          const thisCfg = extraEffectsConfig[index];
          if (thisCfg.type === 'playbackRate') {
            audioPlayer.playbackRate = val;
          } else {
            const newCfg = {...thisCfg, value: val};
            extraEffects[index] = createExtraEffect(newCfg, audioContext);
          }
          extraSliderChanged();
        });
        
        controlDiv.appendChild(label);
        controlDiv.appendChild(slider);
        controlDiv.appendChild(valueDisplay);
        extraControlsContainer.appendChild(controlDiv);
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function openInfoModal(message, extraContent = '') {
      infoModalContent.innerHTML = `<p>${message}</p>${extraContent}<br><button id="closeInfoModal">–ó–∞–∫—Ä—ã—Ç—å</button>`;
      document.getElementById('closeInfoModal').addEventListener('click', () => {
        infoModal.style.display = 'none';
      });
      infoModal.style.display = 'flex';
      
      setTimeout(() => {
        document.querySelectorAll('.reset-single').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const setting = e.target.getAttribute('data-setting');
            if (setting === 'volume') {
              volumeControl.value = 1;
              volumeValue.textContent = '1.00';
              if (gainNode) gainNode.gain.value = 1;
              e.target.parentElement.innerHTML = `<strong>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</strong> 1 <button class="reset-single" data-setting="volume">üîÅ</button>`;
            } else if (setting === 'delay') {
              delayControl.value = 0;
              delayValue.textContent = '0.00';
              if (delayNode) delayNode.delayTime.value = 0;
              e.target.parentElement.innerHTML = `<strong>–ó–∞–¥–µ—Ä–∂–∫–∞:</strong> 0 —Å–µ–∫ <button class="reset-single" data-setting="delay">üîÅ</button>`;
            } else if (e.target.hasAttribute('data-extra-index')) {
              const index = e.target.getAttribute('data-extra-index');
              const cfg = extraEffectsConfig[index];
              const slider = document.getElementById('extraControl' + index);
              if (slider) {
                slider.value = cfg.value;
                const display = slider.parentElement.querySelector('.value-display');
                if (display) display.textContent = `–ó–Ω–∞—á–µ–Ω–∏–µ: ${cfg.value}`;
                slider.dispatchEvent(new Event('input'));
                const li = document.querySelector('li[data-extra-index="'+index+'"]');
                if (li) {
                  li.innerHTML = `<strong>${cfg.name}:</strong> ${cfg.value} <button class="reset-single" data-extra-index="${index}">üîÅ</button>`;
                }
              }
            }
          });
        });
      }, 100);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
    baseInfoBtn.addEventListener('click', () => {
      if (!audioPlayer.src) {
        openInfoModal("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –µ–≥–æ!");
        return;
      }
      let changedBase = "";
      if (parseFloat(volumeControl.value) !== 1) {
        changedBase += `<p><strong>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</strong> ${volumeControl.value} <button class="reset-single" data-setting="volume">üîÅ</button></p>`;
      }
      if (parseFloat(delayControl.value) !== 0) {
        changedBase += `<p><strong>–ó–∞–¥–µ—Ä–∂–∫–∞:</strong> ${delayControl.value} —Å–µ–∫ <button class="reset-single" data-setting="delay">üîÅ</button></p>`;
      }
      let changedExtras = "";
      for (let i = 0; i < extraEffectsConfig.length; i++) {
        const slider = document.getElementById('extraControl' + i);
        if (slider && parseFloat(slider.value) !== parseFloat(extraEffectsConfig[i].value)) {
          changedExtras += `<li data-extra-index="${i}"><strong>${extraEffectsConfig[i].name}:</strong> ${slider.value} <button class="reset-single" data-extra-index="${i}">üîÅ</button></li>`;
        }
      }
      let modalMessage = "";
      if (changedBase || changedExtras) {
        if (changedBase) {
          modalMessage += `<p><strong>–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong></p>` + changedBase;
        }
        if (changedExtras) {
          modalMessage += `<p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong></p><ul>${changedExtras}</ul>`;
        }
        modalMessage += `<p>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:</p>
                         <audio controls src="${audioPlayer.src}"></audio>
                         <button id="resetBaseBtn" type="button">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>`;
      } else {
        modalMessage = `<p><strong>–ù–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π!</strong></p><p>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:</p>
                         <audio controls src="${audioPlayer.src}"></audio>`;
      }
      openInfoModal(modalMessage);
      
      if (document.getElementById('resetBaseBtn')) {
        document.getElementById('resetBaseBtn').addEventListener('click', () => {
          let changedBaseReset = "";
          if (parseFloat(volumeControl.value) !== 1) {
            changedBaseReset += `<p><strong>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</strong> ${volumeControl.value} <button class="reset-single" data-setting="volume">üîÅ</button></p>`;
          }
          if (parseFloat(delayControl.value) !== 0) {
            changedBaseReset += `<p><strong>–ó–∞–¥–µ—Ä–∂–∫–∞:</strong> ${delayControl.value} —Å–µ–∫ <button class="reset-single" data-setting="delay">üîÅ</button></p>`;
          }
          let changedExtrasReset = "";
          for (let i = 0; i < extraEffectsConfig.length; i++) {
            const slider = document.getElementById('extraControl' + i);
            if (slider && parseFloat(slider.value) !== parseFloat(extraEffectsConfig[i].value)) {
              changedExtrasReset += `<li data-extra-index="${i}"><strong>${extraEffectsConfig[i].name}:</strong> ${slider.value} <button class="reset-single" data-extra-index="${i}">üîÅ</button></li>`;
            }
          }
          volumeControl.value = 1;
          volumeValue.textContent = '1.00';
          delayControl.value = 0;
          delayValue.textContent = '0.00';
          if (gainNode) gainNode.gain.value = 1;
          if (delayNode) delayNode.delayTime.value = 0;
          for (let i = 0; i < extraEffectsConfig.length; i++) {
            const slider = document.getElementById('extraControl' + i);
            if (slider) {
              slider.value = extraEffectsConfig[i].value;
              let display = slider.parentElement.querySelector('.value-display');
              if (display) display.textContent = `–ó–Ω–∞—á–µ–Ω–∏–µ: ${extraEffectsConfig[i].value}`;
              slider.dispatchEvent(new Event('input'));
            }
          }
          let resetMessage = "";
          if (changedBaseReset || changedExtrasReset) {
            if (changedBaseReset) {
              resetMessage += `<p><strong>–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong></p>` + changedBaseReset;
            }
            if (changedExtrasReset) {
              resetMessage += `<p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong></p><ul>${changedExtrasReset}</ul>`;
            }
          } else {
            resetMessage = `<p><strong>–ù–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π!</strong></p>`;
          }
          resetMessage += `<p>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª:</p>
                           <audio controls src="${audioPlayer.src}"></audio>`;
          openInfoModal(resetMessage);
        });
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ info (data-info)
    document.querySelectorAll('label .info-btn[data-info]').forEach(btn => {
      if (btn.id !== 'baseInfoBtn') {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openInfoModal(e.target.getAttribute('data-info'));
        });
      }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    audioUpload.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        if (localStorage.getItem('created_musics')){
          localStorage.setItem('created_musics', String(Number(localStorage.getItem('created_musics')) + 1));
        }
        else{
          localStorage.setItem('created_musics', '1');
        }
        originalFileName = file.name;
        audioFile = file;
        const fileURL = URL.createObjectURL(file);
        audioPlayer.src = fileURL;
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
        initAudioContext();

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        document.querySelector('.upload-section').style.display = 'none';

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–æ–Ω-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
        const visCanvas = document.getElementById('visualizerBackground');
        visCanvas.style.display = 'block';

        // –°–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º –µ–≥–æ –∫ –≤—ã—Ö–æ–¥—É gainNode
        visualizerAnalyser = audioContext.createAnalyser();
        visualizerAnalyser.fftSize = 256;
        gainNode.connect(visualizerAnalyser);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
        drawVisualizer();
      }
    });
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
    volumeControl.addEventListener('input', () => {
      if (gainNode) {
        gainNode.gain.value = parseFloat(volumeControl.value);
        volumeValue.textContent = parseFloat(volumeControl.value).toFixed(2);
      }
    });
    
    delayControl.addEventListener('input', () => {
      if (delayNode) {
        delayNode.delayTime.value = parseFloat(delayControl.value);
        delayValue.textContent = parseFloat(delayControl.value).toFixed(2);
      }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    toggleExtra.addEventListener('click', () => {
      if (!audioPlayer.src) {
        openInfoModal("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω.<br>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –ø—Ä–æ—Å–ª—É—à–∞—Ç—å –µ–≥–æ!");
        return;
      }
      if (extraTools.style.display === "none" || extraTools.style.display === "") {
        extraTools.style.display = "block";
        toggleExtra.textContent = "–°–≤–µ—Ä–Ω—É—Ç—å‚¨ÜÔ∏è";
      } else {
        extraTools.style.display = "none";
        toggleExtra.textContent = "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å‚¨áÔ∏è";
      }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–∫–∏
    closeOverlay.addEventListener('click', () => {
      document.getElementById('overlay').style.display = 'none';
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioContext ‚Äì –∞–≤—Ç–æ-–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
    function initAudioContext() {
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      audioContext.resume();
      // –ê—É–¥–∏–æ-—ç–ª–µ–º–µ–Ω—Ç –æ—Å—Ç–∞–µ—Ç—Å—è muted ‚Äì –∑–≤—É–∫ –≤—ã–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ AudioContext
      audioPlayer.muted = true;
      
      sourceNode = audioContext.createMediaElementSource(audioPlayer);
      gainNode = audioContext.createGain();
      delayNode = audioContext.createDelay(2.0);
      
      extraEffects = extraEffectsConfig.map(cfg => createExtraEffect(cfg));
      
      sourceNode.connect(gainNode);
      gainNode.connect(delayNode);
      // –ï—Å–ª–∏ –≤—Å–µ extra-—Å–ª–∞–π–¥–µ—Ä—ã –Ω–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ, bypassExtraEffects=true
      bypassExtraEffects = true;
      delayNode.connect(audioContext.destination);
      
      if (!extraControlsGenerated) {
        generateExtraControls();
        extraControlsGenerated = true;
      }
    }
    
    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ native-–∫–Ω–æ–ø–∫—É Play AudioContext –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–µ—Å–ª–∏ –≤ suspended)
    audioPlayer.addEventListener('play', () => {
      if (audioContext && audioContext.state !== "running") {
        audioContext.resume();
      }
    });

    /* --- –ö–æ–¥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ --- */
    let visualizerCanvas = document.getElementById('visualizerBackground');
    let visualizerCtx = visualizerCanvas.getContext('2d');
    let visualizerAnalyser;
    
    function resizeVisualizer() {
      visualizerCanvas.width = window.innerWidth;
      visualizerCanvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeVisualizer);
    resizeVisualizer();
    
    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      if (!visualizerAnalyser) return;
      let bufferLength = visualizerAnalyser.frequencyBinCount;
      let dataArray = new Uint8Array(bufferLength);
      visualizerAnalyser.getByteFrequencyData(dataArray);
      visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
      
      let barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
      let barHeight;
      let x = 0;
      
      for (let i = 0; i < bufferLength; i++) {
        barHeight = dataArray[i];
        visualizerCtx.fillStyle = `rgb(${barHeight+100},50,${255-barHeight})`;
        visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
        x += barWidth + 1;
      }
    }
    /* --- –ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ --- */

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ
    async function renderProcessedAudio() {
      if (!audioPlayer.src) return null;
      try {
        const response = await fetch(audioPlayer.src);
        const arrayBuffer = await response.arrayBuffer();
        const originalBuffer = await audioContext.decodeAudioData(arrayBuffer);
        const offlineContext = new OfflineAudioContext(originalBuffer.numberOfChannels, originalBuffer.length, originalBuffer.sampleRate);
        const offlineSource = offlineContext.createBufferSource();
        offlineSource.buffer = originalBuffer;
        const offlineGain = offlineContext.createGain();
        offlineGain.gain.value = gainNode.gain.value;
        const offlineDelay = offlineContext.createDelay(2.0);
        offlineDelay.delayTime.value = delayNode.delayTime.value;
        const offlineExtraEffects = [];
        let playbackRateVal = 1;
        for (let i = 0; i < extraEffectsConfig.length; i++) {
          const slider = document.getElementById(`extraControl${i}`);
          const val = parseFloat(slider.value);
          const cfg = {...extraEffectsConfig[i], value: val};
          if (cfg.type === 'playbackRate') {
            playbackRateVal = val;
          } else {
            const effectData = createExtraEffect(cfg, offlineContext);
            offlineExtraEffects.push(effectData);
          }
        }
        offlineSource.playbackRate.value = playbackRateVal;
        offlineSource.connect(offlineGain);
        offlineGain.connect(offlineDelay);
        let lastNode = offlineDelay;
        if (offlineExtraEffects.length > 0) {
          lastNode.connect(offlineExtraEffects[0].node);
          for (let i = 0; i < offlineExtraEffects.length - 1; i++) {
            offlineExtraEffects[i].node.connect(offlineExtraEffects[i + 1].node);
          }
          offlineExtraEffects[offlineExtraEffects.length - 1].node.connect(offlineContext.destination);
        } else {
          lastNode.connect(offlineContext.destination);
        }
        offlineSource.start(0);
        const renderedBuffer = await offlineContext.startRendering();
        return audioBufferToWav(renderedBuffer);
      } catch (error) {
        console.error(error);
        return null;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ AudioBuffer –≤ WAV Blob
    function audioBufferToWav(buffer) {
      const numOfChan = buffer.numberOfChannels;
      const length = buffer.length * numOfChan * 2 + 44;
      const out = new ArrayBuffer(length);
      const view = new DataView(out);
      writeString(view, 0, 'RIFF');
      view.setUint32(4, length - 8, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, numOfChan, true);
      view.setUint32(24, buffer.sampleRate, true);
      view.setUint32(28, buffer.sampleRate * numOfChan * 2, true);
      view.setUint16(32, numOfChan * 2, true);
      view.setUint16(34, 16, true);
      writeString(view, 36, 'data');
      view.setUint32(40, buffer.length * numOfChan * 2, true);
      let offset = 44;
      for (let i = 0; i < buffer.length; i++) {
        for (let channel = 0; channel < numOfChan; channel++) {
          const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
          view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
          offset += 2;
        }
      }
      return new Blob([out], {type: 'audio/wav'});
    }

    function writeString(view, offset, string) {
      for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
      }
    }
  </script>
</body>
</html>