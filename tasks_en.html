<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Daily Tasks and Rewards</title>
  <style>
    :root{
      --bg:#060039;
      --text:#d9d9d9;
      --accent:#251897;
      --card:#0b0b2b;
      --glass: rgba(255,255,255,0.03);
      --success: #22c55e;
      --error: #ef4444;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    .app{max-width:1100px;margin:24px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .back-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:10px 14px;border-radius:12px;text-decoration:none;font-weight:600}
    .coins{font-weight:700}
    main{display:grid;grid-template-columns:1fr 420px;gap:20px;margin-top:20px}

    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(2,2,8,0.6)}
    .calendar{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
    .day{background:var(--card);border-radius:12px;padding:12px;height:88px;display:flex;flex-direction:column;justify-content:space-between}
    .day.claimed{opacity:0.6;box-shadow:inset 0 0 0 2px rgba(0,0,0,0.2)}
    .day.today{outline:2px solid rgba(37,24,151,0.5)}
    .day .num{font-weight:700}
    .day .reward{font-size:13px}
    .day button{margin-top:8px;padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:13px;}

    .tasks-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .task{background:var(--glass);border-radius:12px;padding:12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
    .task .title{font-weight:700}
    .task .meta{font-size:13px;opacity:0.85;margin-top:6px}
    .task .buttons{display:flex;gap:8px;margin-top:10px}
    .btn{padding:8px 10px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer;transition: background 0.2s;}
    .btn:hover{background:#3a2ab8;}
    .btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.06);transition: border-color 0.2s;}
    .btn.alt:hover{border-color:rgba(255,255,255,0.12);}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:1000;transition: opacity 0.3s ease;}
    .modal-content{background:var(--card);padding:24px;border-radius:16px;max-width:420px;width:90%;text-align:left;position:relative;box-shadow:0 4px 20px rgba(0,0,0,0.3);animation: fadeIn 0.3s ease;}
    @keyframes fadeIn {from {opacity:0;transform:scale(0.95);} to {opacity:1;transform:scale(1);}}
    .modal-content h1{font-size:20px;font-weight:700;margin-bottom:12px;text-align:center;}
    .modal-content .description{margin-bottom:16px;line-height:1.5;font-size:14px;}
    .modal-content .meta{font-size:16px;font-weight:bold;opacity:0.9;margin-bottom:8px;}
    .modal-content .buttons{display:flex;flex-direction:column;gap:12px;margin-top:20px;}
    .modal-content .buttons button{width:100%;}
    .close-btn{position:absolute;top:16px;right:16px;cursor:pointer;color:var(--text);font-size:24px;transition: color 0.2s;}
    .close-btn:hover{color:white;}

    .toast{display:flex;align-items:center;position:fixed;bottom:40px;left:50%;transform:translateX(-50%);background:var(--card);border-radius:12px;padding:16px;max-width:400px;width:calc(100% - 40px);box-shadow:0 4px 12px rgba(0,0,0,0.4);z-index:9999;animation:slideUp 0.3s ease-out;color:var(--text);}
    @keyframes slideUp{from{opacity:0;transform:translate(-50%,20px);}to{opacity:1;transform:translate(-50%,0);}}
    .toast-icon{display:flex;align-items:center;justify-content:center;flex-shrink:0;width:32px;height:32px;border-radius:50%;}
    .toast.success .toast-icon{background:rgba(34,197,94,0.2);color:var(--success);}
    .toast.error .toast-icon{background:rgba(239,68,68,0.2);color:var(--error);}
    .toast-text{margin-left:12px;font-size:16px;font-weight:500;flex:1;}
    .toast-close{margin-left:auto;background:none;border:none;color:var(--text);opacity:0.6;cursor:pointer;padding:0 8px;transition:opacity 0.2s;}
    .toast-close:hover{opacity:1;}
    .toast svg{width:20px;height:20px;}

    .side{position:sticky;top:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px}
    .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:10px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#5b3cff);width:0%}

    footer{margin-top:18px;text-align:center;color:rgba(217,217,217,0.6);font-size:13px}

    @media (max-width:900px){
      main{grid-template-columns:1fr}
      .coins{font-size:14px}
    }
    @media (max-width:768px){
      .calendar{grid-template-columns:repeat(3,1fr)}
      body {font-size:14px;}
      .day {height:70px; padding:10px;}
      .day .num {font-size:15px;}
      .day .reward {font-size:11px;}
      .day button {font-size:11px; padding:6px 8px;}
      .task .title {font-size:14px;}
      .task .meta {font-size:11px;}
      .btn {font-size:12px; padding:6px 8px;}
      .calendar {gap:8px;}
      .tasks-list {gap:8px;}
      .modal-content {padding:16px;}
      .modal-content h1 {font-size:18px;}
      .modal-content .description {font-size:12px;}
      .modal-content .meta {font-size:14px;}
      .app {padding:10px;}
      header {gap:8px;}
      .back-btn {font-size:14px; padding:8px 12px;}
      .coins {font-size:14px;}
      footer {font-size:11px;}
    }
    @media (max-width:480px){
      body {font-size:12px;}
      .day {height:60px; padding:8px;}
      .day .num {font-size:13px;}
      .day .reward {font-size:10px;}
      .day button {font-size:10px; padding:5px 7px;}
      .task .title {font-size:12px;}
      .task .meta {font-size:10px;}
      .btn {font-size:10px; padding:5px 7px;}
      .calendar {grid-template-columns:repeat(2,1fr); gap:6px;}
      .modal-content {padding:12px; max-width:90%;}
      .modal-content h1 {font-size:16px;}
      .modal-content .description {font-size:11px;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <a class="back-btn" href="main.html">RETURN TO MAIN MENU</a>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="coins" id="coinsDisplay">0ðŸª™</div>
      </div>
    </header>

    <main>
      <section class="panel">
        <h2>Rewards</h2>
        <p style="opacity:0.8">Rewards can be collected one per day. If you have Premium, you can collect missed rewards.</p>

        <div style="margin-top:14px">
          <div class="calendar" id="calendar"></div>
        </div>
      </section>

      <aside class="side">
        <div class="card">
          <h3>Progress</h3>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div>Days collected: <span id="collectedCount">0</span>/30</div>
            <div id="currentDayLabel">Day 1</div>
          </div>
          <div style="margin-top:10px" class="progress"><i id="progressBar"></i></div>
          <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
            <button class="btn" id="collectToday">Claim reward (today)</button>
            <button class="btn alt" id="collectAllMissed">Claim all missed rewards</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card" style="margin-top:12px">
          <h3>
            Tasks
            (Click on any task to learn details)
          </h3>
          <div class="tasks-list" id="tasksList"></div>
        </div>
      </aside>
    </main>

    <footer>
      If you want to add your own task, write to support: RETURN TO MAIN MENU > In the upper right corner, click the Menu button > Settings > Open the "Support and Contact" section > Click "Write to support"
    </footer>
  </div>

  <!-- Modal -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">Ã—</span>
      <h1 id="modalTitle"></h1>
      <div class="description" id="modalDescription"></div>
      <div id="modalExpires" class="meta"></div>
      <div id="modalReward" class="meta"></div>
      <div class="buttons">
        <button class="btn alt" id="modalActionBtn"></button>
        <button class="btn" id="modalCheckBtn"></button>
        <button class="btn alt" id="modalBackBtn">Back</button>
      </div>
    </div>
  </div>

  <script>
    /* ----------------------
       1. Rewards initialization: 29th = 10 000, 30th = 50 000
       ----------------------*/
    let DAILY_REWARDS = JSON.parse(localStorage.getItem('dailyRewards') || 'null');
    if (!DAILY_REWARDS) {
      DAILY_REWARDS = [];
      const start = 100;
      const end = 5000;
      const days = 28;
      const increment = Math.floor((end - start) / (days - 1));
      for (let i = 0; i < days; i++) {
        DAILY_REWARDS.push(start + i * increment);
      }
      DAILY_REWARDS.push(10000);  // 29th day
      DAILY_REWARDS.push(50000);  // 30th day
      localStorage.setItem('dailyRewards', JSON.stringify(DAILY_REWARDS));
    }

    /* ----------------------
       2. Auto-reset calendar after 30th day
       ----------------------*/
    function resetCycleIfNeeded() {
      const claimed = getClaimed();
      const todayIndex = dayIndexFromStart();
      if (claimed.includes(29) && todayIndex >= 30) {
        localStorage.setItem('rewardsStart', new Date().toISOString().slice(0,10));
        localStorage.setItem('claimedDays', JSON.stringify([]));
        renderAll();
      }
    }

    /* ----------------------
       3. All tasks (without changes)
       ----------------------*/
    const TASKS = [
      {
        id: 'task1',
        title: 'Subscribe to the channel',
        description: 'Go to the page and subscribe, then click Check.',
        checkText: 'Check',
        actionText: 'Go',
        actionLink: 'https://t.me/NickNaymes2Bot',
        conditionCode: 'return await checkSubscription("@NickNaymes2Bot");',
        expires: '',
        rewardText: '1 000',
        rewardCode: 'return 1000;',
        showConditionCode: 'return localStorage.getItem("userID")'
      },
      {
        id: 'task2',
        title: 'Link your Telegram ID',
        description: `To receive the reward, you need to link your Telegram ID in the settings.\n1. Open the main menu of the application.\n2. In the upper right corner, click the "Menu" button.\n3. Select "Settings".\n4. In the "Account" section, click "Link Telegram ID" and enter your ID.\n5. Click "Save".`,
        checkText: 'Check',
        actionText: 'Go to main menu',
        actionLink: 'main.html',
        conditionCode: "return !!localStorage.getItem('userID');",
        expires: '',
        rewardText: '500',
        rewardCode: 'return 500;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task3',
        title: 'Add nickname to favorites',
        description: `To receive the reward, you need to add any nickname to favorites.`,
        checkText: 'Check',
        actionText: 'Go to main menu',
        actionLink: 'main.html',
        conditionCode: "return !!localStorage.getItem('loved');",
        expires: '',
        rewardText: '255',
        rewardCode: 'return 255;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task4',
        title: 'Add description to favorites',
        description: 'To receive the reward, you need to create any description and add it to favorites.',
        checkText: 'Check',
        actionText: 'Go to main menu',
        actionLink: 'main.html',
        conditionCode: "return !!localStorage.getItem('loved_descs');",
        expires: '',
        rewardText: '255',
        rewardCode: 'return 255;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task5',
        title: 'Buy any item in the store',
        description: 'To receive the reward, you need to buy absolutely any item in the store.',
        checkText: 'Check',
        actionText: 'Go to store',
        actionLink: 'shop_ru.html',
        conditionCode: "return !!localStorage.getItem('bought');",
        expires: '',
        rewardText: '200',
        rewardCode: 'return 200;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task6',
        title: 'Buy Premium',
        description: 'To receive the reward, you need to buy Premium.',
        checkText: 'Check',
        actionText: 'Go to buy Premium',
        actionLink: 'premium.screen.html',
        conditionCode: "return !!localStorage.getItem('premium');",
        expires: '',
        rewardText: '200 000',
        rewardCode: 'return 200000;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task7',
        title: 'Create your first LEGO figure',
        description: 'To receive the reward, you need to create your LEGO figure.',
        checkText: 'Check',
        actionText: 'Go to create LEGO figure',
        actionLink: 'main.html',
        conditionCode: "return !!localStorage.getItem('created_lego');",
        expires: '',
        rewardText: '555',
        rewardCode: 'return 555;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task8',
        title: function() { return `Create LEGO figure 8 times(${localStorage.getItem('created_lego')||0}/8)`; },
        description: 'To receive the reward, you need to create your LEGO figure 8 times.',
        checkText: 'Check',
        actionText: 'Go to create LEGO figure',
        actionLink: 'main.html',
        conditionCode: "return await checkCountForTasks(localStorage.getItem('created_lego'), 8);",
        expires: '',
        rewardText: '800',
        rewardCode: 'return 800;',
        showConditionCode: 'return !!localStorage.getItem("created_lego")'
      },
      {
        id: 'task9',
        title: 'Add your first Avatar to profile.',
        description: 'To receive the reward, you need to add your first avatar.',
        checkText: 'Check',
        actionText: 'Go to profile',
        actionLink: 'user_profile.html',
        conditionCode: "return await checkAvatarForTask()",
        expires: '',
        rewardText: '300',
        rewardCode: 'return 300;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task10',
        title: 'Subscribe to the channel.',
        description: 'Subscribe to the channel to receive the reward.',
        checkText: 'Check',
        actionText: 'Go to channel',
        actionLink: 'https://t.me/online1_Islam',
        conditionCode: "return await checkSubscription('@online1_Islam');",
        expires: '',
        rewardText: '1 000',
        rewardCode: 'return 1000;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task11',
        title: function() { return `Create 18 nicknames(${localStorage.getItem('created_nicknames')||0}/18)`; },
        description: 'To receive the reward, you need to create 18 nicknames.',
        checkText: 'Check',
        actionText: 'Go to create nicknames',
        actionLink: 'nickname.html',
        conditionCode: "return await checkCountForTasks(localStorage.getItem('created_nicknames'), 18);",
        expires: '',
        rewardText: '1 000',
        rewardCode: 'return 1000;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task12',
        title: 'Create your first avatar',
        description: 'To receive the reward, you need to create your first avatar.',
        checkText: 'Check',
        actionText: 'Go to create avatar',
        actionLink: 'avatar.html',
        conditionCode: "return localStorage.getItem('created_profiles')",
        expires: '',
        rewardText: '200',
        rewardCode: 'return 200;',
        showConditionCode: 'return true;'
      },
      {
        id: 'task13',
        title: function() { return `Create 5 avatars(${localStorage.getItem('created_profiles')||0}/5)`; },
        description: 'To receive the reward, you need to create 5 avatars.',
        checkText: 'Check',
        actionText: 'Go to create avatar',
        actionLink: 'avatar.html',
        conditionCode: "return await checkCountForTasks(localStorage.getItem('created_profiles'), 5);",
        expires: '',
        rewardText: '600',
        rewardCode: 'return 600;',
        showConditionCode: "return localStorage.getItem('task12_claimed') === 'true';"
      },
      {
        id: 'task14',
        title: function() { return `Share created nickname with friends(${localStorage.getItem('shared_nicknames')||0}/3)`; },
        description: 'To receive the reward, you need to share the created nickname with friends 3 times.',
        checkText: 'Check',
        actionText: 'Go to create nicknames',
        actionLink: 'nickname.html',
        conditionCode: "return await checkCountForTasks(localStorage.getItem('shared_nicknames'), 3);",
        expires: '',
        rewardText: '400',
        rewardCode: 'return 300;',
        showConditionCode: "return true;"
      },
      {
        id: 'task15',
        title: function() { return `Share created description with friends(${localStorage.getItem('shared_descriptions')||0}/3)`; },
        description: 'To receive the reward, you need to share the created description with friends 3 times.',
        checkText: 'Check',
        actionText: 'Go to create descriptions',
        actionLink: 'description.html',
        conditionCode: "return await checkCountForTasks(localStorage.getItem('shared_descriptions'), 3);",
        expires: '',
        rewardText: '400',
        rewardCode: 'return 300;',
        showConditionCode: "return true;"
      },
      {
        id: 'task20',
        title: `Come up with a name for yourself in the "My Profile" menu`,
        description: 'To receive the reward, you need to come up with a name for yourself in the "My Profile" menu.',
        checkText: 'Check',
        actionText: 'Go to my profile',
        actionLink: 'user_profile.html',
        conditionCode: "return localStorage.getItem('userName') !== 'User'",
        expires: '',
        rewardText: '266',
        rewardCode: 'return 266;',
        showConditionCode: "return true;"
      },
    ];

    function checkAvatarForTask() {
      return localStorage.getItem('userAvatar') !== 'user_profile_photo.png';
    }

    async function checkCountForTasks(count, required) {
      return (Number(count) || 0) >= required;
    }

    async function checkSubscription(CHANNEL_ID) {
      const BOT_TOKEN = "6537497957:AAGZS4adwPVJSlx16YCCDrKjO96rDK7ZstI";
      const USER_ID = localStorage.getItem('userID');
      try {
        const url = `https://api.telegram.org/bot${BOT_TOKEN}/getChatMember?chat_id=${CHANNEL_ID}&user_id=${USER_ID}`;
        const response = await fetch(url);
        const data = await response.json();
        if (!data.ok) return false;
        const status = data.result.status;
        return ["member", "administrator", "creator"].includes(status);
      } catch (err) {
        console.error(err);
        return false;
      }
    }

    /* ----------------------
       Main logic
       ----------------------*/
    if (!localStorage.getItem('coins')) localStorage.setItem('coins', '0');
    if (!localStorage.getItem('rewardsStart')) localStorage.setItem('rewardsStart', new Date().toISOString().slice(0,10));
    if (!localStorage.getItem('claimedDays')) localStorage.setItem('claimedDays', JSON.stringify([]));

    const coinsDisplay = document.getElementById('coinsDisplay');
    const calendarEl = document.getElementById('calendar');
    const tasksList = document.getElementById('tasksList');
    const collectedCountEl = document.getElementById('collectedCount');
    const progressBar = document.getElementById('progressBar');
    const currentDayLabel = document.getElementById('currentDayLabel');
    const collectTodayBtn = document.getElementById('collectToday');
    const collectAllMissedBtn = document.getElementById('collectAllMissed');

    function getCoins() { return parseInt(localStorage.getItem('coins') || '0', 10); }
    function setCoins(n) { localStorage.setItem('coins', String(n)); renderCoins(); }
    function renderCoins() { coinsDisplay.textContent = `ðŸª™${getCoins()}`; }

    function getStartDate() { return new Date(localStorage.getItem('rewardsStart')); }
    function dayIndexFromStart() {
      const diff = Math.floor((Date.UTC(new Date().getFullYear(), new Date().getMonth(), new Date().getDate()) -
        Date.UTC(getStartDate().getFullYear(), getStartDate().getMonth(), getStartDate().getDate())) / 86400000);
      return Math.max(0, diff);
    }

    function getClaimed() { try { return JSON.parse(localStorage.getItem('claimedDays') || '[]'); } catch { return []; } }
    function setClaimed(arr) { localStorage.setItem('claimedDays', JSON.stringify(arr)); }

    function canClaimIndex(index) {
      if (getClaimed().includes(index)) return false;
      const today = dayIndexFromStart();
      if (index === today) return true;
      if (index < today) return localStorage.getItem('premium') === 'yes';
      return false;
    }

    function claimIndex(index) {
      if (!canClaimIndex(index)) return false;
      setCoins(getCoins() + DAILY_REWARDS[index]);
      const claimed = getClaimed();
      claimed.push(index);
      setClaimed(claimed);
      renderAll();
      return true;
    }

    function claimAllMissed() {
      if (localStorage.getItem('premium') !== 'yes') {
        showToast('Premium required', 'error');
        return;
      }
      let total = 0;
      for (let i = 0; i < dayIndexFromStart(); i++) {
        if (!getClaimed().includes(i)) {
          total += DAILY_REWARDS[i];
          claimIndex(i);
        }
      }
      if (total > 0) showToast(`Received ${total}ðŸª™ for missed days!`, 'success');
    }

    function parseDateDDMMYYYY(s) {
      if (!s) return null;
      const [d, m, y] = s.split('.').map(Number);
      return new Date(y, m - 1, d);
    }

    function isTaskExpired(task) {
      if (!task.expires) return false;
      const exp = parseDateDDMMYYYY(task.expires);
      if (!exp) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      return exp < today;
    }

    function renderCalendar() {
      calendarEl.innerHTML = '';
      const claimed = getClaimed();
      const todayIndex = dayIndexFromStart();
      const now = new Date();

      for (let i = 0; i < 30; i++) {
        const day = document.createElement('div');
        day.className = 'day';
        if (claimed.includes(i)) day.classList.add('claimed');
        if (i === todayIndex) day.classList.add('today');

        day.innerHTML = `<div><div class="num">Day ${i+1}</div><div class="reward">${DAILY_REWARDS[i]}ðŸª™</div></div>`;
        const btn = document.createElement('button');

        if (claimed.includes(i)) {
          btn.textContent = 'Claimed'; btn.disabled = true; btn.style.opacity = 0.6;
        } else if (i > todayIndex) {
          const future = new Date(getStartDate());
          future.setDate(future.getDate() + i);
          const diff = future - now;
          const d = Math.floor(diff / 86400000);
          const h = Math.floor((diff % 86400000) / 3600000);
          const m = Math.floor((diff % 3600000) / 60000);
          const s = Math.floor((diff % 60000) / 1000);
          btn.textContent = `${String(d).padStart(2,'0')} d. ${String(h).padStart(2,'0')}h. ${String(m).padStart(2,'0')}m. ${String(s).padStart(2,'0')}s.`;
          btn.disabled = true;
        } else if (i < todayIndex && localStorage.getItem('premium') !== 'yes') {
          btn.textContent = 'Premium'; btn.disabled = true;
        } else {
          btn.textContent = 'Claim';
          btn.onclick = () => {
            if (claimIndex(i)) showToast(`Received ${DAILY_REWARDS[i]}ðŸª™`, 'success');
            else showToast('Cannot claim', 'error');
          };
        }
        day.appendChild(btn);
        calendarEl.appendChild(day);
      }
    }

    function renderTasks() {
      tasksList.innerHTML = '';
      for (const t of TASKS) {
        let show = true;
        if (t.showConditionCode) {
          try { show = new Function(t.showConditionCode)(); } catch { show = false; }
        }
        if (!show) continue;

        const taskEl = document.createElement('div');
        taskEl.className = 'task';
        const expired = isTaskExpired(t);
        const claimed = !!localStorage.getItem(t.id + '_claimed');

        const title = typeof t.title === 'function' ? t.title() : t.title;
        taskEl.innerHTML = `<div class="title">${title} (${t.rewardText}ðŸª™)</div>`;
        const btn = document.createElement('button');
        btn.className = 'btn';

        if (claimed) {
          btn.textContent = 'Claimed'; btn.disabled = true; btn.style.opacity = 0.6;
        } else if (expired) {
          btn.textContent = 'Expired'; btn.disabled = true; btn.style.opacity = 0.6;
        } else {
          btn.textContent = t.checkText;
          btn.onclick = async (e) => {
            e.stopPropagation();
            if (expired) {
              showToast('The deadline for this task has expired.', 'error');
              return;
            }
            try {
              const fn = new Function('return async function(){' + t.conditionCode + '}')();
              const ok = await fn();
              if (ok) {
                const reward = new Function(t.rewardCode)();
                setCoins(getCoins() + reward);
                localStorage.setItem(t.id + '_claimed', 'true');
                showToast(`Task completed â€” received ${reward}ðŸª™`, 'success');
                renderAll();
              } else {
                showToast('Condition not met', 'error');
              }
            } catch (err) {
              console.error(err);
              showToast('Verification error', 'error');
            }
          };
        }
        taskEl.appendChild(btn);
        taskEl.onclick = () => showModal(t);
        tasksList.appendChild(taskEl);
      }
    }

    function renderProgress() {
      const claimed = getClaimed().length;
      progressBar.style.width = Math.round((claimed / 30) * 100) + '%';
      collectedCountEl.textContent = claimed;
      currentDayLabel.textContent = `Day ${dayIndexFromStart() + 1}`;
    }

    function renderCollectToday() {
      const today = dayIndexFromStart();
      if (getClaimed().includes(today)) {
        collectTodayBtn.textContent = 'Claimed (today)';
        collectTodayBtn.disabled = true;
        collectTodayBtn.style.opacity = 0.6;
      } else {
        collectTodayBtn.textContent = 'Claim reward (today)';
        collectTodayBtn.disabled = false;
        collectTodayBtn.style.opacity = 1;
      }
    }

    function renderCollectAllMissed() {
      const isPremium = localStorage.getItem('premium') === 'yes';
      collectAllMissedBtn.textContent = isPremium
        ? 'Claim all missed rewards'
        : 'Claim all missed rewards (Premium)';
      collectAllMissedBtn.disabled = !isPremium;
      collectAllMissedBtn.style.opacity = isPremium ? 1 : 0.6;
    }

    function renderAll() {
      renderCoins();
      renderCalendar();
      renderTasks();
      renderProgress();
      renderCollectToday();
      renderCollectAllMissed();
      resetCycleIfNeeded();
    }

    collectTodayBtn.onclick = () => {
      const today = dayIndexFromStart();
      if (claimIndex(today)) showToast(`Received ${DAILY_REWARDS[today]}ðŸª™`, 'success');
      else showToast('Already claimed today', 'error');
    };

    collectAllMissedBtn.onclick = claimAllMissed;

    function showToast(text, type = 'info') {
      document.querySelectorAll('.toast').forEach(t => t.remove());
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icon = type === 'success'
        ? `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>`
        : `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"/></svg>`;
      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-text">${text}</div>
        <button class="toast-close"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg></button>
      `;
      document.body.appendChild(toast);
      toast.querySelector('.toast-close').onclick = () => toast.remove();
      setTimeout(() => toast.remove(), 5000);
    }

    const modal = document.getElementById('taskModal');
    const closeModal = document.getElementById('closeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalDescription = document.getElementById('modalDescription');
    const modalExpires = document.getElementById('modalExpires');
    const modalReward = document.getElementById('modalReward');
    const modalActionBtn = document.getElementById('modalActionBtn');
    const modalCheckBtn = document.getElementById('modalCheckBtn');
    const modalBackBtn = document.getElementById('modalBackBtn');

    function showModal(task) {
      modalTitle.textContent = typeof task.title === 'function' ? task.title() : task.title;
      modalDescription.textContent = task.description;
      modalReward.textContent = `Reward: ${task.rewardText} coinsðŸª™`;
      const expired = isTaskExpired(task);
      modalExpires.textContent = task.expires ? `Until: ${task.expires}${expired ? ' Â· Expired' : ''}` : '';
      modalActionBtn.textContent = task.actionText;
      modalActionBtn.onclick = () => location.href = task.actionLink;

      const claimed = !!localStorage.getItem(task.id + '_claimed');
      if (claimed || expired) {
        modalCheckBtn.textContent = claimed ? 'Claimed' : 'Expired';
        modalCheckBtn.disabled = true;
        modalCheckBtn.style.opacity = 0.6;
      } else {
        modalCheckBtn.textContent = task.checkText;
        modalCheckBtn.onclick = async () => {
          if (expired) { showToast('The deadline for this task has expired.', 'error'); return; }
          try {
            const fn = new Function('return async function(){' + task.conditionCode + '}')();
            const ok = await fn();
            if (ok) {
              const reward = new Function(task.rewardCode)();
              setCoins(getCoins() + reward);
              localStorage.setItem(task.id + '_claimed', 'true');
              showToast(`Task completed â€” received ${reward}ðŸª™`, 'success');
              renderAll();
              modal.style.display = 'none';
            } else {
              showToast('Condition not met', 'error');
            }
          } catch (e) { showToast('Error', 'error'); }
        };
      }
      modal.style.display = 'flex';
    }

    closeModal.onclick = modalBackBtn.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

    renderAll();
    setInterval(() => {
      renderCalendar();
      renderCollectToday();
      renderCollectAllMissed();
      resetCycleIfNeeded();
    }, 1000);

    window.APP = { TASKS, DAILY_REWARDS };
  </script>
</body>
</html>